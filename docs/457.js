"use strict";(self.webpackChunkmap_observer=self.webpackChunkmap_observer||[]).push([[457],{6457:(Me,x,a)=>{a.r(x),a.d(x,{MapViewPageModule:()=>ue});var m=a(9808),e=a(5e3);let j=(()=>{class t{}return t.\u0275fac=function(n){return new(n||t)},t.\u0275mod=e.oAB({type:t}),t.\u0275inj=e.cJS({imports:[[m.ez]]}),t})();var F=a(3477),l=a(7319);let X=(()=>{class t{constructor(n){this.store=n}ngOnInit(){}}return t.\u0275fac=function(n){return new(n||t)(e.Y36(l.yh))},t.\u0275cmp=e.Xpm({type:t,selectors:[["app-mapping-items-view"]],decls:0,vars:0,template:function(n,i){},styles:[""]}),t})();var S=a(655),y=a(8407),V=a(2937),d=a(561),I=a(1135),u=a(9841),E=a(4986),P=a(4482),$=a(5403),Q=a(8421);const J={leading:!0,trailing:!1};var N=a(5963);function b(t,o=E.z,n=J){const i=(0,N.H)(t,o);return function D(t,{leading:o,trailing:n}=J){return(0,P.e)((i,s)=>{let p=!1,r=null,c=null,Z=!1;const ge=()=>{null==c||c.unsubscribe(),c=null,n&&(R(),Z&&s.complete())},ve=()=>{c=null,Z&&s.complete()},z=f=>c=(0,Q.Xf)(t(f)).subscribe(new $.Q(s,ge,ve)),R=()=>{if(p){p=!1;const f=r;r=null,s.next(f),!Z&&z(f)}};i.subscribe(new $.Q(s,f=>{p=!0,r=f,(!c||c.closed)&&(o?R():z(f))},()=>{Z=!0,(!(n&&p&&c)||c.closed)&&s.complete()}))})}(()=>i,n)}var O=a(3151),L=a(9300),g=a(4004),C=a(4987),H=a(457),T=a(3125),G=a(5698),U=a(9889),q=a(1829),K=a(543);function W(t,o){if(1&t){const n=e.EpF();e.TgZ(0,"div",5),e._UZ(1,"app-asset-view",6),e.TgZ(2,"button",7),e.NdJ("click",function(){const p=e.CHM(n).$implicit;return e.oxw().removeAsset.emit(p.id)}),e._uU(3,"\u0432\u0438\u0434\u0430\u043b\u0438\u0442\u0438"),e.qZA(),e.qZA()}if(2&t){const n=o.$implicit;e.xp6(1),e.Q6J("asset",n)}}function k(t,o){if(1&t){const n=e.EpF();e.TgZ(0,"div",8),e._UZ(1,"app-asset-movement",9),e.TgZ(2,"button",7),e.NdJ("click",function(){const p=e.CHM(n).$implicit;return e.oxw().removeMovement.emit(p.id)}),e._uU(3,"\u0432\u0438\u0434\u0430\u043b\u0438\u0442\u0438"),e.qZA(),e.qZA()}if(2&t){const n=o.$implicit;e.xp6(1),e.Q6J("movement",n)}}let ee=(()=>{class t{constructor(){this.mappingItem=void 0,this.assets=void 0,this.movements=void 0,this.removeAsset=new e.vpe,this.removeMovement=new e.vpe}ngOnInit(){}}return t.\u0275fac=function(n){return new(n||t)},t.\u0275cmp=e.Xpm({type:t,selectors:[["app-mapping-item"]],inputs:{mappingItem:"mappingItem",assets:"assets",movements:"movements"},outputs:{removeAsset:"removeAsset",removeMovement:"removeMovement"},decls:12,vars:3,consts:[[1,"border","p-1"],[1,"assets-container"],["class","d-flex flex-row",4,"ngFor","ngForOf"],[1,"movements-container"],["class","d-flex flex-row border p-1",4,"ngFor","ngForOf"],[1,"d-flex","flex-row"],[1,"flex-grow-1",3,"asset"],[1,"btn","btn-link","flex-grow-0",3,"click"],[1,"d-flex","flex-row","border","p-1"],[1,"flex-grow-1",3,"movement"]],template:function(n,i){1&n&&(e.TgZ(0,"div",0),e._uU(1),e.qZA(),e.TgZ(2,"div",0),e.TgZ(3,"h4"),e._uU(4,"\u0410\u043a\u0442\u0438\u0432\u0438"),e.qZA(),e.TgZ(5,"div",1),e.YNc(6,W,4,1,"div",2),e.qZA(),e.qZA(),e.TgZ(7,"div",0),e.TgZ(8,"h4"),e._uU(9,"\u041f\u0435\u0440\u0435\u043c\u0456\u0449\u0435\u043d\u043d\u044f"),e.qZA(),e.TgZ(10,"div",3),e.YNc(11,k,4,1,"div",4),e.qZA(),e.qZA()),2&n&&(e.xp6(1),e.Oqu(null==i.mappingItem?null:i.mappingItem.description),e.xp6(5),e.Q6J("ngForOf",i.assets),e.xp6(5),e.Q6J("ngForOf",i.movements))},directives:[m.sg,q.F,K.W],styles:[".assets-container[_ngcontent-%COMP%], .movements-container[_ngcontent-%COMP%]{max-height:100px;overflow:auto;overflow-x:hidden}"],changeDetection:0}),t})();function te(t,o){if(1&t){const n=e.EpF();e.TgZ(0,"app-mapping-item",1),e.NdJ("removeAsset",function(s){return e.CHM(n),e.oxw().removeAsset(s)})("removeMovement",function(s){return e.CHM(n),e.oxw().removeMovement(s)}),e.ALo(1,"async"),e.ALo(2,"async"),e.qZA()}if(2&t){const n=o.ngIf,i=e.oxw();e.Q6J("mappingItem",n)("assets",e.lcZ(1,3,i.assets$))("movements",e.lcZ(2,5,i.movements$))}}let ne=(()=>{class t{constructor(n){this.store=n,this._id=new I.X(void 0),this.mappingItem$=(0,u.a)([this._id,this.store.pipe((0,l.Ys)(d.q.selectItemsEntities))]).pipe((0,g.U)(([i,s])=>i?s[i]:void 0)),this.assets$=(0,u.a)([this.mappingItem$,this.store.pipe((0,l.Ys)(d.q.selectAssetsEntities))]).pipe((0,g.U)(([i,s])=>{var p;return(null===(p=null==i?void 0:i.assets)||void 0===p?void 0:p.map(r=>s[r]))||[]})),this.movements$=(0,u.a)([this.mappingItem$,this.store.pipe((0,l.Ys)(d.q.selectAssetMovementsEntities))]).pipe((0,g.U)(([i,s])=>{var p;return(null===(p=null==i?void 0:i.movements)||void 0===p?void 0:p.map(r=>s[r]))||[]}))}set id(n){this._id.next(n)}get id(){return this._id.value}ngOnInit(){}removeAsset(n){this.id&&this.store.dispatch((0,T.XR)({assets:[n],mappingItem:this.id}))}removeMovement(n){this.id&&this.store.dispatch((0,T.S4)({movements:[n],mappingItem:this.id}))}}return t.\u0275fac=function(n){return new(n||t)(e.Y36(l.yh))},t.\u0275cmp=e.Xpm({type:t,selectors:[["app-mapping-item-standalone"]],inputs:{id:"id"},decls:2,vars:3,consts:[[3,"mappingItem","assets","movements","removeAsset","removeMovement",4,"ngIf"],[3,"mappingItem","assets","movements","removeAsset","removeMovement"]],template:function(n,i){1&n&&(e.YNc(0,te,3,7,"app-mapping-item",0),e.ALo(1,"async")),2&n&&e.Q6J("ngIf",e.lcZ(1,1,i.mappingItem$))},directives:[m.O5,ee],pipes:[m.Ov],styles:[""],changeDetection:0}),t})();function oe(t,o){1&t&&e._UZ(0,"app-mapping-item-standalone",8),2&t&&e.Q6J("id",o.ngIf)}let v=class{constructor(o,n){this.activeModal=o,this.store=n,this._movementId=new I.X(void 0),this.itemIdByMovement$=this.store.pipe((0,l.Ys)(d.q.selectItemIdByMovement)),this.selectedItemId$=(0,u.a)([this._movementId,this.itemIdByMovement$]).pipe((0,g.U)(([i,s])=>i?s[i]:void 0))}set movementId(o){this._movementId.next(o)}get movementId(){return this._movementId.value}ngOnInit(){}deleteItem(){this.selectedItemId$.pipe((0,G.q)(1),(0,C.t)(this)).subscribe(o=>{o&&this.store.dispatch((0,T.UA)({ids:[o]}))})}onCancel(){this.activeModal.dismiss()}};v.\u0275fac=function(o){return new(o||v)(e.Y36(U.Kz),e.Y36(l.yh))},v.\u0275cmp=e.Xpm({type:v,selectors:[["app-mapping-item-modal"]],inputs:{movementId:"movementId"},decls:13,vars:3,consts:[[1,"modal-header"],[1,"modal-title"],[1,"modal-body"],[1,"text-secondary"],[3,"id",4,"ngIf"],[1,"modal-footer"],[1,"btn","btn-secondary",3,"click"],["type","button",1,"btn","btn-link",3,"click"],[3,"id"]],template:function(o,n){1&o&&(e.TgZ(0,"div",0),e.TgZ(1,"h4",1),e.TgZ(2,"span"),e._uU(3," \u041e\u0431\u0440\u0430\u043d\u043e \u0437\u0430\u043f\u0438\u0441 "),e.qZA(),e.qZA(),e.qZA(),e.TgZ(4,"div",2),e._UZ(5,"div",3),e.YNc(6,oe,1,1,"app-mapping-item-standalone",4),e.ALo(7,"async"),e.qZA(),e.TgZ(8,"div",5),e.TgZ(9,"button",6),e.NdJ("click",function(){return n.deleteItem()}),e._uU(10,"\u0412\u0438\u0434\u0430\u043b\u0438\u0442\u0438"),e.qZA(),e.TgZ(11,"button",7),e.NdJ("click",function(){return n.onCancel()}),e._uU(12," \u0412\u0456\u0434\u0431\u0456\u0439 "),e.qZA(),e.qZA()),2&o&&(e.xp6(6),e.Q6J("ngIf",e.lcZ(7,1,n.selectedItemId$)))},directives:[m.O5,ne],pipes:[m.Ov],styles:[""],changeDetection:0}),v=(0,S.gn)([(0,C.c)()],v);let ie=(()=>{class t{constructor(n,i){this.modalService=n,this.store=i,this.openedModal=null}showMappingItemByMovement(n){var i;return null===(i=this.openedModal)||void 0===i||i.close(),this.openedModal=this.modalService.open(v,{keyboard:!1,backdrop:"static",size:"lg"}),this.openedModal.componentInstance.movementId=n,(0,H.D)(this.openedModal.result)}}return t.\u0275fac=function(n){return new(n||t)(e.LFG(U.FF),e.LFG(l.yh))},t.\u0275prov=e.Yz7({token:t,factory:t.\u0275fac,providedIn:"root"}),t})();var h=a(2382);const se=["map"],ae={radius:3,fillColor:"#ff7800",color:"#000",weight:1,opacity:1,fillOpacity:.8},w=36e5;let M=class{constructor(o,n){this.store=o,this.mappingItemModalService=n,this.rangeSliderMax=5e3,this.assets$=this.store.pipe((0,l.Ys)(d.q.selectAssetsAll)),this.movements$=this.store.pipe((0,l.Ys)(d.q.selectAssetMovementsAll)),this.movementsTimeRange$=this.store.pipe((0,l.Ys)(d.q.selectAssetMovementsTimeRange)),this._timeRange=new I.X(0),this.currentTime$=(0,u.a)([this._timeRange.pipe(b(50)),this.movementsTimeRange$]).pipe((0,g.U)(([i,s])=>s.start+Math.floor((s.end-s.start)*i/this.rangeSliderMax)),(0,O.d)({bufferSize:1,refCount:!0})),this.currentMovements$=(0,u.a)([this.movements$,this.currentTime$]).pipe((0,g.U)(([i,s])=>i.filter(p=>function pe(t,o){return t.start<=o&&t.end>=o||t.start>=o-w&&t.start<=o+w||t.end>=o-w&&t.end<=o+w}(p,s))),(0,O.d)({bufferSize:1,refCount:!0})),this.map$=new I.X(null),this.geoJsonLayer$=new I.X(null)}set timeRange(o){this._timeRange.next(o)}get timeRange(){return this._timeRange.value}ngOnInit(){const o=this.currentMovements$.pipe((0,g.U)(n=>({type:"FeatureCollection",features:n.map(i=>Object.assign(Object.assign({},i.geo),{properties:{id:i.id}}))})));(0,u.a)([o,this.geoJsonLayer$,this.map$]).pipe((0,L.h)(([n,i,s])=>!!i&&!!s),(0,C.t)(this)).subscribe(([n,i,s])=>{null==i||i.clearLayers(),n&&(null==i||i.addData(n))})}ngAfterViewInit(){var o;const n=y.map(null===(o=this.mapElement)||void 0===o?void 0:o.nativeElement).setView(V.E,V.T);y.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:18,minZoom:3,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(n);const s=y.geoJSON(void 0,{pointToLayer:(p,r)=>y.circleMarker(r,ae),onEachFeature:(p,r)=>{r.on("click",c=>{this.showMoment(p.properties.id)})}});s.setStyle(p=>({color:(null==p?void 0:p.properties.color)||"#ffffff"})),this.geoJsonLayer$.next(s),s.addTo(n),this.map$.next(n)}showMoment(o){this.mappingItemModalService.showMappingItemByMovement(o).subscribe()}};M.\u0275fac=function(o){return new(o||M)(e.Y36(l.yh),e.Y36(ie))},M.\u0275cmp=e.Xpm({type:M,selectors:[["app-map-view"]],viewQuery:function(o,n){if(1&o&&e.Gf(se,5),2&o){let i;e.iGM(i=e.CRH())&&(n.mapElement=i.first)}},decls:9,vars:8,consts:[[1,"border","p-3"],["type","range","min","0",1,"slider",3,"max","ngModel","ngModelChange"],[1,"map-container"],[1,"map-frame"],[1,"map"],["map",""]],template:function(o,n){1&o&&(e.TgZ(0,"div",0),e.TgZ(1,"input",1),e.NdJ("ngModelChange",function(s){return n.timeRange=s}),e.qZA(),e._uU(2),e.ALo(3,"date"),e.ALo(4,"async"),e.qZA(),e.TgZ(5,"div",2),e.TgZ(6,"div",3),e._UZ(7,"div",4,5),e.qZA(),e.qZA()),2&o&&(e.xp6(1),e.Q6J("max",n.rangeSliderMax)("ngModel",n.timeRange),e.xp6(1),e.hij(" ",e.xi3(3,3,e.lcZ(4,6,n.currentTime$),"HH:mm dd-MM"),"\n"))},directives:[h.eT,h.Fj,h.JJ,h.On],pipes:[m.uU,m.Ov],styles:[".slider[_ngcontent-%COMP%]{width:100%}.map[_ngcontent-%COMP%]{width:100%;height:800px}"],changeDetection:0}),M=(0,S.gn)([(0,C.c)()],M);const me=[{path:"",component:(()=>{class t{constructor(){}ngOnInit(){}}return t.\u0275fac=function(n){return new(n||t)},t.\u0275cmp=e.Xpm({type:t,selectors:[["app-map-view-page"]],decls:2,vars:0,template:function(n,i){1&n&&(e._UZ(0,"app-mapping-items-view"),e._UZ(1,"app-map-view"))},directives:[X,M],styles:[""],changeDetection:0}),t})()}];let re=(()=>{class t{}return t.\u0275fac=function(n){return new(n||t)},t.\u0275mod=e.oAB({type:t}),t.\u0275inj=e.cJS({imports:[[F.Bz.forChild(me)],F.Bz]}),t})();var _=a(8796),Y=a(4741);let A=(()=>{class t{}return t.\u0275fac=function(n){return new(n||t)},t.\u0275mod=e.oAB({type:t}),t.\u0275inj=e.cJS({imports:[[m.ez,_.o,Y.Y]]}),t})(),B=(()=>{class t{}return t.\u0275fac=function(n){return new(n||t)},t.\u0275mod=e.oAB({type:t}),t.\u0275inj=e.cJS({imports:[[m.ez,_.o,Y.Y,A]]}),t})(),le=(()=>{class t{}return t.\u0275fac=function(n){return new(n||t)},t.\u0275mod=e.oAB({type:t}),t.\u0275inj=e.cJS({imports:[[m.ez,A,B]]}),t})(),ce=(()=>{class t{}return t.\u0275fac=function(n){return new(n||t)},t.\u0275mod=e.oAB({type:t}),t.\u0275inj=e.cJS({imports:[[m.ez,le,A,B]]}),t})(),de=(()=>{class t{}return t.\u0275fac=function(n){return new(n||t)},t.\u0275mod=e.oAB({type:t}),t.\u0275inj=e.cJS({imports:[[m.ez,h.u5,h.UX,ce]]}),t})(),ue=(()=>{class t{}return t.\u0275fac=function(n){return new(n||t)},t.\u0275mod=e.oAB({type:t}),t.\u0275inj=e.cJS({imports:[[m.ez,j,re,de]]}),t})()}}]);