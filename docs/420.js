"use strict";(self.webpackChunkmap_observer=self.webpackChunkmap_observer||[]).push([[420],{5420:(yt,_,p)=>{p.r(_),p.d(_,{MapViewPageModule:()=>ft});var l=p(9808),F=p(3477),t=p(5e3),S=p(655),A=p(8407),b=p(2937),d=p(7319),g=p(561),Z=p(1135),v=p(9841),j=p(4986),R=p(4482),$=p(5403),z=p(8421);const J={leading:!0,trailing:!1};var X=p(5963);function B(e,o=j.z,n=J){const i=(0,X.H)(e,o);return function Q(e,{leading:o,trailing:n}=J){return(0,R.e)((i,s)=>{let a=!1,m=null,r=null,c=!1;const Mt=()=>{null==r||r.unsubscribe(),r=null,n&&(N(),c&&s.complete())},It=()=>{r=null,c&&s.complete()},P=I=>r=(0,z.Xf)(e(I)).subscribe(new $.Q(s,Mt,It)),N=()=>{if(a){a=!1;const I=m;m=null,s.next(I),!c&&P(I)}};i.subscribe(new $.Q(s,I=>{a=!0,m=I,(!r||r.closed)&&(o?N():P(I))},()=>{c=!0,(!(n&&a&&r)||r.closed)&&s.complete()}))})}(()=>i,n)}var D=p(7579),L=p(6063);class q extends D.x{constructor(o=1/0,n=1/0,i=L.l){super(),this._bufferSize=o,this._windowTime=n,this._timestampProvider=i,this._buffer=[],this._infiniteTimeWindow=!0,this._infiniteTimeWindow=n===1/0,this._bufferSize=Math.max(1,o),this._windowTime=Math.max(1,n)}next(o){const{isStopped:n,_buffer:i,_infiniteTimeWindow:s,_timestampProvider:a,_windowTime:m}=this;n||(i.push(o),!s&&i.push(a.now()+m)),this._trimBuffer(),super.next(o)}_subscribe(o){this._throwIfClosed(),this._trimBuffer();const n=this._innerSubscribe(o),{_infiniteTimeWindow:i,_buffer:s}=this,a=s.slice();for(let m=0;m<a.length&&!o.closed;m+=i?1:2)o.next(a[m]);return this._checkFinalizedStatuses(o),n}_trimBuffer(){const{_bufferSize:o,_timestampProvider:n,_buffer:i,_infiniteTimeWindow:s}=this,a=(s?1:2)*o;if(o<1/0&&a<i.length&&i.splice(0,i.length-a),!s){const m=n.now();let r=0;for(let c=1;c<i.length&&i[c]<=m;c+=2)r=c;r&&i.splice(0,r+1)}}}var H=p(3099);function U(e,o,n){var i,s;let a,m=!1;return e&&"object"==typeof e?(a=null!==(i=e.bufferSize)&&void 0!==i?i:1/0,o=null!==(s=e.windowTime)&&void 0!==s?s:1/0,m=!!e.refCount,n=e.scheduler):a=null!=e?e:1/0,(0,H.B)({connector:()=>new q(a,o,n),resetOnError:!0,resetOnComplete:!1,resetOnRefCountZero:m})}var W=p(9300),h=p(4004),T=p(4987),G=p(457),u=p(3125),k=p(5698),O=p(9889),C=p(1205),K=p(914),tt=p(8726),et=p(1829),nt=p(543);function it(e,o){if(1&e){const n=t.EpF();t.TgZ(0,"div",8),t._UZ(1,"app-asset-view",9),t.TgZ(2,"div",10),t.TgZ(3,"button",11),t.NdJ("click",function(){const a=t.CHM(n).$implicit;return t.oxw().editAsset(a)}),t._uU(4,"\u0440\u0435\u0434."),t.qZA(),t.TgZ(5,"button",12),t.NdJ("click",function(){const a=t.CHM(n).$implicit;return t.oxw().removeAsset(a.id)}),t._uU(6,"\u043f\u0440\u0438\u0431."),t.qZA(),t.qZA(),t.qZA()}if(2&e){const n=o.$implicit;t.xp6(1),t.Q6J("asset",n)}}function ot(e,o){if(1&e){const n=t.EpF();t.TgZ(0,"div",13),t._UZ(1,"app-asset-movement",14),t.TgZ(2,"div",15),t.TgZ(3,"button",11),t.NdJ("click",function(){const a=t.CHM(n).$implicit;return t.oxw().editMovement(a)}),t._uU(4,"\u0440\u0435\u0434."),t.qZA(),t.TgZ(5,"button",12),t.NdJ("click",function(){const a=t.CHM(n).$implicit;return t.oxw().removeMovement(a.id)}),t._uU(6,"\u043f\u0440\u0438\u0431. "),t.qZA(),t.qZA(),t.qZA()}if(2&e){const n=o.$implicit;t.xp6(1),t.Q6J("movement",n)}}let st=(()=>{class e{constructor(n,i,s){this.store=n,this.assetFormModalService=i,this.movementFormModalService=s,this.mappingItem=void 0,this.assets=void 0,this.movements=void 0}ngOnInit(){}removeAsset(n){var i;n&&this.mappingItem&&(0,C.n)(this.mappingItem)&&this.store.dispatch((0,u.XR)({assets:[n],mappingItem:null===(i=this.mappingItem)||void 0===i?void 0:i.id}))}removeMovement(n){var i;n&&this.mappingItem&&(0,C.n)(this.mappingItem)&&this.store.dispatch((0,u.S4)({movements:[n],mappingItem:null===(i=this.mappingItem)||void 0===i?void 0:i.id}))}editAsset(n){this.assetFormModalService.editAsset(n).subscribe({next:i=>{this.store.dispatch((0,u.Oq)({assets:[i]}))},error:i=>{}})}editMovement(n){this.movementFormModalService.editMovement(n).subscribe({next:i=>{this.store.dispatch((0,u.hr)({movements:[i]}))},error:i=>{}})}selectAndAddAsset(){this.assetFormModalService.selectAsset().subscribe(n=>{var i;this.mappingItem&&(0,C.n)(this.mappingItem)&&this.store.dispatch((0,u.Oq)({assets:n,mappingItem:null===(i=this.mappingItem)||void 0===i?void 0:i.id}))})}addNewAsset(){this.assetFormModalService.addAsset().subscribe(n=>{var i;this.mappingItem&&(0,C.n)(this.mappingItem)&&this.store.dispatch((0,u.Oq)({assets:[n],mappingItem:null===(i=this.mappingItem)||void 0===i?void 0:i.id}))})}addNewMovement(){this.movementFormModalService.addMovement().subscribe({next:n=>{var i;this.mappingItem&&(0,C.n)(this.mappingItem)&&this.store.dispatch((0,u.hr)({movements:[n],mappingItem:null===(i=this.mappingItem)||void 0===i?void 0:i.id}))},error:n=>{}})}}return e.\u0275fac=function(n){return new(n||e)(t.Y36(d.yh),t.Y36(K.r),t.Y36(tt.a))},e.\u0275cmp=t.Xpm({type:e,selectors:[["app-mapping-item"]],inputs:{mappingItem:"mappingItem",assets:"assets",movements:"movements"},decls:20,vars:3,consts:[[1,"border","p-1"],[1,"assets-container","container"],["class","row border",4,"ngFor","ngForOf"],[1,"d-flex","flex-row"],[1,"btn","btn-outline-primary","flex-grow-0",3,"click"],[1,"btn","btn-outline-secondary","flex-grow-0",3,"click"],[1,"movements-container","container"],["class","row border p-1",4,"ngFor","ngForOf"],[1,"row","border"],[1,"col-md-10",3,"asset"],[1,"col-md-2"],[1,"btn","btn-link","flex-grow-0",3,"click"],[1,"btn","btn-link","flex-grow-0","text-danger",3,"click"],[1,"row","border","p-1"],[1,"flex-grow-1","col-md-10",3,"movement"],[1,"flex-grow-0","col-md-2"]],template:function(n,i){1&n&&(t.TgZ(0,"div",0),t._uU(1),t.qZA(),t.TgZ(2,"div",0),t.TgZ(3,"h4"),t._uU(4,"\u0410\u043a\u0442\u0438\u0432\u0438"),t.qZA(),t.TgZ(5,"div",1),t.YNc(6,it,7,1,"div",2),t.qZA(),t.TgZ(7,"div",3),t.TgZ(8,"button",4),t.NdJ("click",function(){return i.selectAndAddAsset()}),t._uU(9,"\u0434\u043e\u0434\u0430\u0442\u0438 \u0456\u0441\u043d\u0443\u044e\u0447\u0438\u0439"),t.qZA(),t.TgZ(10,"button",5),t.NdJ("click",function(){return i.addNewAsset()}),t._uU(11,"\u0441\u0442\u0432\u043e\u0440\u0438\u0442\u0438 \u043d\u043e\u0432\u0438\u0439 "),t.qZA(),t.qZA(),t.qZA(),t.TgZ(12,"div",0),t.TgZ(13,"h4"),t._uU(14,"\u041f\u043e\u0437\u0438\u0446\u0456\u0457"),t.qZA(),t.TgZ(15,"div",6),t.YNc(16,ot,7,1,"div",7),t.qZA(),t.TgZ(17,"div",3),t.TgZ(18,"button",5),t.NdJ("click",function(){return i.addNewMovement()}),t._uU(19,"\u0441\u0442\u0432\u043e\u0440\u0438\u0442\u0438 \u043d\u043e\u0432\u0438\u0439 "),t.qZA(),t.qZA(),t.qZA()),2&n&&(t.xp6(1),t.Oqu(null==i.mappingItem?null:i.mappingItem.description),t.xp6(5),t.Q6J("ngForOf",i.assets),t.xp6(10),t.Q6J("ngForOf",i.movements))},directives:[l.sg,et.F,nt.W],styles:[".assets-container[_ngcontent-%COMP%], .movements-container[_ngcontent-%COMP%]{max-height:300px;overflow:auto;overflow-x:hidden}"],changeDetection:0}),e})();function at(e,o){if(1&e&&(t._UZ(0,"app-mapping-item",1),t.ALo(1,"async"),t.ALo(2,"async")),2&e){const n=o.ngIf,i=t.oxw();t.Q6J("mappingItem",n)("assets",t.lcZ(1,3,i.assets$))("movements",t.lcZ(2,5,i.movements$))}}let pt=(()=>{class e{constructor(n){this.store=n,this._id=new Z.X(void 0),this.mappingItem$=(0,v.a)([this._id,this.store.pipe((0,d.Ys)(g.q.selectItemsEntities))]).pipe((0,h.U)(([i,s])=>i?s[i]:void 0)),this.assets$=(0,v.a)([this.mappingItem$,this.store.pipe((0,d.Ys)(g.q.selectAssetsEntities))]).pipe((0,h.U)(([i,s])=>{var a;return(null===(a=null==i?void 0:i.assets)||void 0===a?void 0:a.map(m=>s[m]))||[]})),this.movements$=(0,v.a)([this.mappingItem$,this.store.pipe((0,d.Ys)(g.q.selectAssetMovementsEntities))]).pipe((0,h.U)(([i,s])=>{var a;return(null===(a=null==i?void 0:i.movements)||void 0===a?void 0:a.map(m=>s[m]))||[]}))}set id(n){this._id.next(n)}get id(){return this._id.value}ngOnInit(){}}return e.\u0275fac=function(n){return new(n||e)(t.Y36(d.yh))},e.\u0275cmp=t.Xpm({type:e,selectors:[["app-mapping-item-standalone"]],inputs:{id:"id"},decls:2,vars:3,consts:[[3,"mappingItem","assets","movements",4,"ngIf"],[3,"mappingItem","assets","movements"]],template:function(n,i){1&n&&(t.YNc(0,at,3,7,"app-mapping-item",0),t.ALo(1,"async")),2&n&&t.Q6J("ngIf",t.lcZ(1,1,i.mappingItem$))},directives:[l.O5,st],pipes:[l.Ov],styles:[""],changeDetection:0}),e})();function mt(e,o){1&e&&t._UZ(0,"app-mapping-item-standalone",7),2&e&&t.Q6J("id",o.ngIf)}let f=class{constructor(o,n){this.activeModal=o,this.store=n,this._movementId=new Z.X(void 0),this.itemIdByMovement$=this.store.pipe((0,d.Ys)(g.q.selectItemIdByMovement)),this.selectedItemId$=(0,v.a)([this._movementId,this.itemIdByMovement$]).pipe((0,h.U)(([i,s])=>i?s[i]:void 0))}set movementId(o){this._movementId.next(o)}get movementId(){return this._movementId.value}ngOnInit(){}deleteItem(){this.selectedItemId$.pipe((0,k.q)(1),(0,T.t)(this)).subscribe(o=>{o&&this.store.dispatch((0,u.UA)({ids:[o]}))})}onCancel(){this.activeModal.dismiss()}};f.\u0275fac=function(o){return new(o||f)(t.Y36(O.Kz),t.Y36(d.yh))},f.\u0275cmp=t.Xpm({type:f,selectors:[["app-mapping-item-modal"]],inputs:{movementId:"movementId"},decls:11,vars:3,consts:[[1,"modal-header"],[1,"modal-title"],[1,"modal-body"],[1,"text-secondary"],[3,"id",4,"ngIf"],[1,"modal-footer"],["type","button",1,"btn","btn-link",3,"click"],[3,"id"]],template:function(o,n){1&o&&(t.TgZ(0,"div",0),t.TgZ(1,"h4",1),t.TgZ(2,"span"),t._uU(3," \u041e\u0431\u0440\u0430\u043d\u043e \u0437\u0430\u043f\u0438\u0441 "),t.qZA(),t.qZA(),t.qZA(),t.TgZ(4,"div",2),t._UZ(5,"div",3),t.YNc(6,mt,1,1,"app-mapping-item-standalone",4),t.ALo(7,"async"),t.qZA(),t.TgZ(8,"div",5),t.TgZ(9,"button",6),t.NdJ("click",function(){return n.onCancel()}),t._uU(10," \u0437\u0430\u043a\u0440\u0438\u0442\u0438 "),t.qZA(),t.qZA()),2&o&&(t.xp6(6),t.Q6J("ngIf",t.lcZ(7,1,n.selectedItemId$)))},directives:[l.O5,pt],pipes:[l.Ov],styles:[""],changeDetection:0}),f=(0,S.gn)([(0,T.c)()],f);let rt=(()=>{class e{constructor(n,i){this.modalService=n,this.store=i,this.openedModal=null}showMappingItemByMovement(n){var i;return null===(i=this.openedModal)||void 0===i||i.close(),this.openedModal=this.modalService.open(f,{keyboard:!1,backdrop:"static",size:"lg"}),this.openedModal.componentInstance.movementId=n,(0,G.D)(this.openedModal.result)}addNewItem(){}}return e.\u0275fac=function(n){return new(n||e)(t.LFG(O.FF),t.LFG(d.yh))},e.\u0275prov=t.Yz7({token:e,factory:e.\u0275fac,providedIn:"root"}),e})();var y=p(2382);const lt=["map"],w=36e5;let M=class{constructor(o,n){this.store=o,this.mappingItemModalService=n,this.rangeSliderMax=5e3,this.assets$=this.store.pipe((0,d.Ys)(g.q.selectAssetsAll)),this.movements$=this.store.pipe((0,d.Ys)(g.q.selectAssetMovementsAll)),this.movementsTimeRange$=this.store.pipe((0,d.Ys)(g.q.selectAssetMovementsTimeRange)),this._timeRange=new Z.X(0),this.currentTime$=(0,v.a)([this._timeRange.pipe(B(50)),this.movementsTimeRange$]).pipe((0,h.U)(([i,s])=>s.start+Math.floor((s.end-s.start)*i/this.rangeSliderMax)),U({bufferSize:1,refCount:!0})),this.currentMovements$=(0,v.a)([this.movements$,this.currentTime$]).pipe((0,h.U)(([i,s])=>i.filter(a=>function dt(e,o){return e.start<=o&&e.end>=o||e.start>=o-w&&e.start<=o+w||e.end>=o-w&&e.end<=o+w}(a,s))),U({bufferSize:1,refCount:!0})),this.map$=new Z.X(null),this.geoJsonLayer$=new Z.X(null)}set timeRange(o){this._timeRange.next(o)}get timeRange(){return this._timeRange.value}addItem(){}ngOnInit(){const o=this.currentMovements$.pipe((0,h.U)(n=>({type:"FeatureCollection",features:n.map(i=>Object.assign(Object.assign({},i.geo),{properties:{id:i.id}}))})));(0,v.a)([o,this.geoJsonLayer$,this.map$]).pipe((0,W.h)(([n,i,s])=>!!i&&!!s),(0,T.t)(this)).subscribe(([n,i,s])=>{null==i||i.clearLayers(),n&&(null==i||i.addData(n))})}ngAfterViewInit(){var o;const n=A.map(null===(o=this.mapElement)||void 0===o?void 0:o.nativeElement).setView(b.E,b.T);A.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:18,minZoom:3,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(n);const s=A.geoJSON(void 0,{onEachFeature:(a,m)=>{m.on("click",r=>{this.showMoment(a.properties.id)})}});s.setStyle(a=>({color:(null==a?void 0:a.properties.color)||"#ffffff"})),this.geoJsonLayer$.next(s),s.addTo(n),this.map$.next(n)}showMoment(o){this.mappingItemModalService.showMappingItemByMovement(o).subscribe()}};M.\u0275fac=function(o){return new(o||M)(t.Y36(d.yh),t.Y36(rt))},M.\u0275cmp=t.Xpm({type:M,selectors:[["app-map-view"]],viewQuery:function(o,n){if(1&o&&t.Gf(lt,5),2&o){let i;t.iGM(i=t.CRH())&&(n.mapElement=i.first)}},decls:9,vars:8,consts:[[1,"border","p-3","flex-grow-0"],["type","range","min","0",1,"slider",3,"max","ngModel","ngModelChange"],[1,"map-container","flex-grow-1"],[1,"map-frame"],[1,"map"],["map",""]],template:function(o,n){1&o&&(t.TgZ(0,"div",0),t.TgZ(1,"input",1),t.NdJ("ngModelChange",function(s){return n.timeRange=s}),t.qZA(),t._uU(2),t.ALo(3,"date"),t.ALo(4,"async"),t.qZA(),t.TgZ(5,"div",2),t.TgZ(6,"div",3),t._UZ(7,"div",4,5),t.qZA(),t.qZA()),2&o&&(t.xp6(1),t.Q6J("max",n.rangeSliderMax)("ngModel",n.timeRange),t.xp6(1),t.hij(" ",t.xi3(3,3,t.lcZ(4,6,n.currentTime$),"HH:mm dd-MM-YYYY"),"\n"))},directives:[y.eT,y.Fj,y.JJ,y.On],pipes:[l.uU,l.Ov],styles:["[_nghost-%COMP%]{height:100%;display:flex;flex-direction:column}.slider[_ngcontent-%COMP%]{width:100%}.map[_ngcontent-%COMP%]{width:100%;height:600px}.map-container[_ngcontent-%COMP%]{margin-right:15px}"],changeDetection:0}),M=(0,S.gn)([(0,T.c)()],M);const ct=[{path:"",component:(()=>{class e{constructor(){}ngOnInit(){}}return e.\u0275fac=function(n){return new(n||e)},e.\u0275cmp=t.Xpm({type:e,selectors:[["app-map-view-page"]],decls:1,vars:0,consts:[[1,"flex-grow-1","pb-1"]],template:function(n,i){1&n&&t._UZ(0,"app-map-view",0)},directives:[M],styles:["[_nghost-%COMP%]{display:flex;flex-direction:column;flex:1}"],changeDetection:0}),e})()}];let ut=(()=>{class e{}return e.\u0275fac=function(n){return new(n||e)},e.\u0275mod=t.oAB({type:e}),e.\u0275inj=t.cJS({imports:[[F.Bz.forChild(ct)],F.Bz]}),e})();var V=p(8796),Y=p(4741);let x=(()=>{class e{}return e.\u0275fac=function(n){return new(n||e)},e.\u0275mod=t.oAB({type:e}),e.\u0275inj=t.cJS({imports:[[l.ez,V.o,Y.Y]]}),e})(),E=(()=>{class e{}return e.\u0275fac=function(n){return new(n||e)},e.\u0275mod=t.oAB({type:e}),e.\u0275inj=t.cJS({imports:[[l.ez,V.o,Y.Y,x]]}),e})(),gt=(()=>{class e{}return e.\u0275fac=function(n){return new(n||e)},e.\u0275mod=t.oAB({type:e}),e.\u0275inj=t.cJS({imports:[[l.ez,x,E]]}),e})(),vt=(()=>{class e{}return e.\u0275fac=function(n){return new(n||e)},e.\u0275mod=t.oAB({type:e}),e.\u0275inj=t.cJS({imports:[[l.ez,gt,x,E]]}),e})(),ht=(()=>{class e{}return e.\u0275fac=function(n){return new(n||e)},e.\u0275mod=t.oAB({type:e}),e.\u0275inj=t.cJS({imports:[[l.ez,y.u5,y.UX,vt]]}),e})(),ft=(()=>{class e{}return e.\u0275fac=function(n){return new(n||e)},e.\u0275mod=t.oAB({type:e}),e.\u0275inj=t.cJS({imports:[[l.ez,ut,ht]]}),e})()}}]);