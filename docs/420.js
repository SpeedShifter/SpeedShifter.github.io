"use strict";(self.webpackChunkmap_observer=self.webpackChunkmap_observer||[]).push([[420],{5420:(Ce,$,m)=>{m.r($),m.d($,{MapViewPageModule:()=>ye});var l=m(9808),F=m(3477),e=m(5e3),S=m(655),T=m(8407),U=m(2937),c=m(7319),h=m(561),y=m(1135),g=m(9841),X=m(4986),z=m(4482),J=m(5403),q=m(8421);const V={leading:!0,trailing:!1};var D=m(5963);function W(n,i=X.z,t=V){const o=(0,D.H)(n,i);return function B(n,{leading:i,trailing:t}=V){return(0,z.e)((o,s)=>{let a=!1,p=null,r=null,v=!1;const Ze=()=>{null==r||r.unsubscribe(),r=null,t&&(Q(),v&&s.complete())},xe=()=>{r=null,v&&s.complete()},L=I=>r=(0,q.Xf)(n(I)).subscribe(new J.Q(s,Ze,xe)),Q=()=>{if(a){a=!1;const I=p;p=null,s.next(I),!v&&L(I)}};o.subscribe(new J.Q(s,I=>{a=!0,p=I,(!r||r.closed)&&(i?Q():L(I))},()=>{v=!0,(!(t&&a&&r)||r.closed)&&s.complete()}))})}(()=>o,t)}var k=m(7579),G=m(6063);class K extends k.x{constructor(i=1/0,t=1/0,o=G.l){super(),this._bufferSize=i,this._windowTime=t,this._timestampProvider=o,this._buffer=[],this._infiniteTimeWindow=!0,this._infiniteTimeWindow=t===1/0,this._bufferSize=Math.max(1,i),this._windowTime=Math.max(1,t)}next(i){const{isStopped:t,_buffer:o,_infiniteTimeWindow:s,_timestampProvider:a,_windowTime:p}=this;t||(o.push(i),!s&&o.push(a.now()+p)),this._trimBuffer(),super.next(i)}_subscribe(i){this._throwIfClosed(),this._trimBuffer();const t=this._innerSubscribe(i),{_infiniteTimeWindow:o,_buffer:s}=this,a=s.slice();for(let p=0;p<a.length&&!i.closed;p+=o?1:2)i.next(a[p]);return this._checkFinalizedStatuses(i),t}_trimBuffer(){const{_bufferSize:i,_timestampProvider:t,_buffer:o,_infiniteTimeWindow:s}=this,a=(s?1:2)*i;if(i<1/0&&a<o.length&&o.splice(0,o.length-a),!s){const p=t.now();let r=0;for(let v=1;v<o.length&&o[v]<=p;v+=2)r=v;r&&o.splice(0,r+1)}}}var ee=m(3099);function Y(n,i,t){var o,s;let a,p=!1;return n&&"object"==typeof n?(a=null!==(o=n.bufferSize)&&void 0!==o?o:1/0,i=null!==(s=n.windowTime)&&void 0!==s?s:1/0,p=!!n.refCount,t=n.scheduler):a=null!=n?n:1/0,(0,ee.B)({connector:()=>new K(a,i,t),resetOnError:!0,resetOnComplete:!1,resetOnRefCountZero:p})}var O=m(9300),te=m(3900),d=m(4004),x=m(4987),A=m(1359),ne=m(457),u=m(3125),P=m(5698),E=m(9889),N=m(8726),H=m(543),C=m(1205),ie=m(914),oe=m(1829);function se(n,i){if(1&n){const t=e.EpF();e.TgZ(0,"div",8),e._UZ(1,"app-asset-view",9),e.TgZ(2,"div",10),e.TgZ(3,"button",11),e.NdJ("click",function(){const a=e.CHM(t).$implicit;return e.oxw().editAsset(a)}),e._uU(4,"\u0440\u0435\u0434."),e.qZA(),e.TgZ(5,"button",12),e.NdJ("click",function(){const a=e.CHM(t).$implicit;return e.oxw().removeAsset(a.id)}),e._uU(6,"\u043f\u0440\u0438\u0431."),e.qZA(),e.qZA(),e.qZA()}if(2&n){const t=i.$implicit;e.xp6(1),e.Q6J("asset",t)}}function ae(n,i){if(1&n){const t=e.EpF();e.TgZ(0,"div",13),e._UZ(1,"app-asset-movement",14),e.TgZ(2,"div",15),e.TgZ(3,"button",11),e.NdJ("click",function(){const a=e.CHM(t).$implicit;return e.oxw().editMovement(a)}),e._uU(4,"\u0440\u0435\u0434."),e.qZA(),e.TgZ(5,"button",12),e.NdJ("click",function(){const a=e.CHM(t).$implicit;return e.oxw().removeMovement(a.id)}),e._uU(6,"\u043f\u0440\u0438\u0431. "),e.qZA(),e.qZA(),e.qZA()}if(2&n){const t=i.$implicit;e.xp6(1),e.Q6J("movement",t)}}let me=(()=>{class n{constructor(t,o,s){this.store=t,this.assetFormModalService=o,this.movementFormModalService=s,this.mappingItem=void 0,this.assets=void 0,this.movements=void 0}ngOnInit(){}removeAsset(t){var o;t&&this.mappingItem&&(0,C.n)(this.mappingItem)&&this.store.dispatch((0,u.XR)({assets:[t],mappingItem:null===(o=this.mappingItem)||void 0===o?void 0:o.id}))}removeMovement(t){var o;t&&this.mappingItem&&(0,C.n)(this.mappingItem)&&this.store.dispatch((0,u.S4)({movements:[t],mappingItem:null===(o=this.mappingItem)||void 0===o?void 0:o.id}))}editAsset(t){this.assetFormModalService.editAsset(t).subscribe({next:o=>{this.store.dispatch((0,u.Oq)({assets:[o]}))},error:o=>{}})}editMovement(t){this.movementFormModalService.editMovement(t).subscribe({next:o=>{this.store.dispatch((0,u.hr)({movements:[o]}))},error:o=>{}})}selectAndAddAsset(){this.assetFormModalService.selectAsset().subscribe(t=>{var o;this.mappingItem&&(0,C.n)(this.mappingItem)&&this.store.dispatch((0,u.Oq)({assets:t,mappingItem:null===(o=this.mappingItem)||void 0===o?void 0:o.id}))})}addNewAsset(){this.assetFormModalService.addAsset().subscribe(t=>{var o;this.mappingItem&&(0,C.n)(this.mappingItem)&&this.store.dispatch((0,u.Oq)({assets:[t],mappingItem:null===(o=this.mappingItem)||void 0===o?void 0:o.id}))})}addNewMovement(){this.movementFormModalService.addMovement().subscribe({next:t=>{var o;this.mappingItem&&(0,C.n)(this.mappingItem)&&this.store.dispatch((0,u.hr)({movements:[t],mappingItem:null===(o=this.mappingItem)||void 0===o?void 0:o.id}))},error:t=>{}})}}return n.\u0275fac=function(t){return new(t||n)(e.Y36(c.yh),e.Y36(ie.r),e.Y36(N.a))},n.\u0275cmp=e.Xpm({type:n,selectors:[["app-mapping-item"]],inputs:{mappingItem:"mappingItem",assets:"assets",movements:"movements"},decls:20,vars:3,consts:[[1,"border","p-1"],[1,"assets-container","container"],["class","row border",4,"ngFor","ngForOf"],[1,"d-flex","flex-row"],[1,"btn","btn-outline-primary","flex-grow-0",3,"click"],[1,"btn","btn-outline-secondary","flex-grow-0",3,"click"],[1,"movements-container","container"],["class","row border p-1",4,"ngFor","ngForOf"],[1,"row","border"],[1,"col-md-10",3,"asset"],[1,"col-md-2"],[1,"btn","btn-link","flex-grow-0",3,"click"],[1,"btn","btn-link","flex-grow-0","text-danger",3,"click"],[1,"row","border","p-1"],[1,"flex-grow-1","col-md-10",3,"movement"],[1,"flex-grow-0","col-md-2"]],template:function(t,o){1&t&&(e.TgZ(0,"div",0),e._uU(1),e.qZA(),e.TgZ(2,"div",0),e.TgZ(3,"h4"),e._uU(4,"\u0410\u043a\u0442\u0438\u0432\u0438"),e.qZA(),e.TgZ(5,"div",1),e.YNc(6,se,7,1,"div",2),e.qZA(),e.TgZ(7,"div",3),e.TgZ(8,"button",4),e.NdJ("click",function(){return o.selectAndAddAsset()}),e._uU(9,"\u0434\u043e\u0434\u0430\u0442\u0438 \u0456\u0441\u043d\u0443\u044e\u0447\u0438\u0439"),e.qZA(),e.TgZ(10,"button",5),e.NdJ("click",function(){return o.addNewAsset()}),e._uU(11,"\u0441\u0442\u0432\u043e\u0440\u0438\u0442\u0438 \u043d\u043e\u0432\u0438\u0439 "),e.qZA(),e.qZA(),e.qZA(),e.TgZ(12,"div",0),e.TgZ(13,"h4"),e._uU(14,"\u041f\u043e\u0437\u0438\u0446\u0456\u0457"),e.qZA(),e.TgZ(15,"div",6),e.YNc(16,ae,7,1,"div",7),e.qZA(),e.TgZ(17,"div",3),e.TgZ(18,"button",5),e.NdJ("click",function(){return o.addNewMovement()}),e._uU(19,"\u0441\u0442\u0432\u043e\u0440\u0438\u0442\u0438 \u043d\u043e\u0432\u0438\u0439 "),e.qZA(),e.qZA(),e.qZA()),2&t&&(e.xp6(1),e.Oqu(null==o.mappingItem?null:o.mappingItem.description),e.xp6(5),e.Q6J("ngForOf",o.assets),e.xp6(10),e.Q6J("ngForOf",o.movements))},directives:[l.sg,oe.F,H.W],styles:[".assets-container[_ngcontent-%COMP%], .movements-container[_ngcontent-%COMP%]{max-height:300px;overflow:auto;overflow-x:hidden}"],changeDetection:0}),n})();function pe(n,i){if(1&n&&(e._UZ(0,"app-mapping-item",1),e.ALo(1,"async"),e.ALo(2,"async")),2&n){const t=i.ngIf,o=e.oxw();e.Q6J("mappingItem",t)("assets",e.lcZ(1,3,o.assets$))("movements",e.lcZ(2,5,o.movements$))}}let re=(()=>{class n{constructor(t){this.store=t,this._id=new y.X(void 0),this.mappingItem$=(0,g.a)([this._id,this.store.pipe((0,c.Ys)(h.q.selectItemsEntities))]).pipe((0,d.U)(([o,s])=>o?s[o]:void 0)),this.assets$=(0,g.a)([this.mappingItem$,this.store.pipe((0,c.Ys)(h.q.selectAssetsEntities))]).pipe((0,d.U)(([o,s])=>{var a;return(null===(a=null==o?void 0:o.assets)||void 0===a?void 0:a.map(p=>s[p]))||[]})),this.movements$=(0,g.a)([this.mappingItem$,this.store.pipe((0,c.Ys)(h.q.selectAssetMovementsEntities))]).pipe((0,d.U)(([o,s])=>{var a;return(null===(a=null==o?void 0:o.movements)||void 0===a?void 0:a.map(p=>s[p]))||[]}))}set id(t){this._id.next(t)}get id(){return this._id.value}ngOnInit(){}}return n.\u0275fac=function(t){return new(t||n)(e.Y36(c.yh))},n.\u0275cmp=e.Xpm({type:n,selectors:[["app-mapping-item-standalone"]],inputs:{id:"id"},decls:2,vars:3,consts:[[3,"mappingItem","assets","movements",4,"ngIf"],[3,"mappingItem","assets","movements"]],template:function(t,o){1&t&&(e.YNc(0,pe,3,7,"app-mapping-item",0),e.ALo(1,"async")),2&t&&e.Q6J("ngIf",e.lcZ(1,1,o.mappingItem$))},directives:[l.O5,me],pipes:[l.Ov],styles:[""],changeDetection:0}),n})();function le(n,i){if(1&n){const t=e.EpF();e.TgZ(0,"section",4),e._UZ(1,"app-asset-movement",8),e.TgZ(2,"button",9),e.NdJ("click",function(){const a=e.CHM(t).ngIf;return e.oxw().editMovement(a)}),e._uU(3,"\u0440\u0435\u0434."),e.qZA(),e.TgZ(4,"button",10),e.NdJ("click",function(){const a=e.CHM(t).ngIf;return e.oxw().removeMovement(a.id)}),e._uU(5,"\u043f\u0440\u0438\u0431."),e.qZA(),e.qZA()}if(2&n){const t=i.ngIf,o=e.oxw();e.xp6(1),e.Q6J("movement",t)("selectedPosition",o.selectedPosition)}}function ce(n,i){1&n&&e._UZ(0,"app-mapping-item-standalone",11),2&n&&e.Q6J("id",i.ngIf)}let f=class{constructor(i,t,o){this.activeModal=i,this.store=t,this.movementFormModalService=o,this._movementId=new y.X(void 0),this.movements$=this.store.pipe((0,c.Ys)(h.q.selectAssetMovementsEntities)),this.movement$=(0,g.a)([this._movementId,this.movements$]).pipe((0,d.U)(([s,a])=>!!s&&a[s]||null)),this.itemIdByMovement$=this.store.pipe((0,c.Ys)(h.q.selectItemIdByMovement)),this.selectedItemId$=(0,g.a)([this._movementId,this.itemIdByMovement$]).pipe((0,d.U)(([s,a])=>s?a[s]:void 0))}set movementId(i){this._movementId.next(i)}get movementId(){return this._movementId.value}ngOnInit(){}deleteItem(){this.selectedItemId$.pipe((0,P.q)(1),(0,x.t)(this)).subscribe(i=>{i&&this.store.dispatch((0,u.UA)({ids:[i]}))})}onCancel(){this.activeModal.dismiss()}editMovement(i){this.movementFormModalService.editMovement(i).subscribe({next:t=>{this.store.dispatch((0,u.hr)({movements:[t]}))},error:t=>{}})}removeMovement(i){this.selectedItemId$.pipe((0,P.q)(1)).subscribe(t=>{i&&t&&this.store.dispatch((0,u.S4)({movements:[i],mappingItem:t}))})}};f.\u0275fac=function(i){return new(i||f)(e.Y36(E.Kz),e.Y36(c.yh),e.Y36(N.a))},f.\u0275cmp=e.Xpm({type:f,selectors:[["app-mapping-item-modal"]],inputs:{movementId:"movementId",selectedPosition:"selectedPosition"},decls:15,vars:6,consts:[[1,"modal-header"],[1,"modal-title"],[1,"modal-body"],["class","my-sm-2 p-2 border",4,"ngIf"],[1,"my-sm-2","p-2","border"],[3,"id",4,"ngIf"],[1,"modal-footer"],["type","button",1,"btn","btn-link",3,"click"],[3,"movement","selectedPosition"],[1,"btn","btn-link",3,"click"],[1,"btn","btn-link","text-danger",3,"click"],[3,"id"]],template:function(i,t){1&i&&(e.TgZ(0,"div",0),e.TgZ(1,"h4",1),e.TgZ(2,"span"),e._uU(3," \u041e\u0431\u0440\u0430\u043d\u0430 \u043f\u043e\u0437\u0438\u0446\u0456\u044f "),e.qZA(),e.qZA(),e.qZA(),e.TgZ(4,"div",2),e.YNc(5,le,6,2,"section",3),e.ALo(6,"async"),e.TgZ(7,"section",4),e.TgZ(8,"h5"),e._uU(9,"\u0410\u0441\u043e\u0446\u0456\u0439\u043e\u0432\u0430\u043d\u0438\u0439 \u0437\u0430\u043f\u0438\u0441"),e.qZA(),e.YNc(10,ce,1,1,"app-mapping-item-standalone",5),e.ALo(11,"async"),e.qZA(),e.qZA(),e.TgZ(12,"div",6),e.TgZ(13,"button",7),e.NdJ("click",function(){return t.onCancel()}),e._uU(14," \u0437\u0430\u043a\u0440\u0438\u0442\u0438 "),e.qZA(),e.qZA()),2&i&&(e.xp6(5),e.Q6J("ngIf",e.lcZ(6,2,t.movement$)),e.xp6(5),e.Q6J("ngIf",e.lcZ(11,4,t.selectedItemId$)))},directives:[l.O5,H.W,re],pipes:[l.Ov],styles:[""],changeDetection:0}),f=(0,S.gn)([(0,x.c)()],f);let de=(()=>{class n{constructor(t,o){this.modalService=t,this.store=o,this.openedModal=null}showMappingItemByMovement(t,o){var s;null===(s=this.openedModal)||void 0===s||s.close(),this.openedModal=this.modalService.open(f,{keyboard:!1,backdrop:"static",size:"lg"});const a=this.openedModal.componentInstance;return a.movementId=t,a.selectedPosition=(0,A.pc)(o),(0,ne.D)(this.openedModal.result)}addNewItem(){}}return n.\u0275fac=function(t){return new(t||n)(e.LFG(E.FF),e.LFG(c.yh))},n.\u0275prov=e.Yz7({token:n,factory:n.\u0275fac,providedIn:"root"}),n})();var Z=m(2382);const ue=["map"],w=36e5;let M=class{constructor(i,t){this.store=i,this.mappingItemModalService=t,this.rangeSliderMax=5e3,this.movements$=this.store.pipe((0,c.Ys)(h.q.selectAssetMovementsAll)),this.movementsTimeRange$=this.store.pipe((0,c.Ys)(h.q.selectAssetMovementsTimeRange)),this._timeRange=new y.X(0),this.currentTime$=(0,g.a)([this._timeRange.pipe(W(50)),this.movementsTimeRange$]).pipe((0,d.U)(([o,s])=>s.start+Math.floor((s.end-s.start)*o/this.rangeSliderMax)),Y({bufferSize:1,refCount:!0})),this.currentMovements$=(0,g.a)([this.movements$,this.currentTime$]).pipe((0,d.U)(([o,s])=>o.filter(a=>function ge(n,i){return n.start<=i&&n.end>=i||n.start>=i-w&&n.start<=i+w||n.end>=i-w&&n.end<=i+w}(a,s))),Y({bufferSize:1,refCount:!0})),this.geoValue$=this.currentMovements$.pipe((0,d.U)(o=>({type:"FeatureCollection",features:o.map(s=>Object.assign(Object.assign({},s.geo),{properties:{id:s.id}}))}))),this.arrowHeadsLayer$=new y.X([]),this.arrowHeadsLines$=this.geoValue$.pipe((0,d.U)(o=>(0,A.UW)(o.features))),this.map$=new y.X(null),this.geoJsonLayer$=new y.X(null)}set timeRange(i){this._timeRange.next(i)}get timeRange(){return this._timeRange.value}addItem(){}ngOnInit(){(0,g.a)([this.geoValue$,this.geoJsonLayer$,this.map$]).pipe((0,O.h)(([i,t,o])=>!!t&&!!o),(0,x.t)(this)).subscribe(([i,t,o])=>{null==t||t.clearLayers(),i&&(null==t||t.addData(i))}),this.map$.pipe((0,O.h)(i=>!!i),(0,te.w)(i=>(0,g.a)([this.arrowHeadsLines$,this.arrowHeadsLayer$]).pipe((0,d.U)(([t,o])=>({lines:t,heads:o,mapObj:i})))),(0,x.t)(this)).subscribe(({lines:i,heads:t,mapObj:o})=>{if(o)if(t.length!==i.length)if(t.length<i.length){const s=Array.from(Array(i.length-t.length)).map((a,p)=>(0,A.Cl)(o));this.arrowHeadsLayer$.next([...t,...s])}else t.slice(i.length).forEach(s=>{s.remove()}),this.arrowHeadsLayer$.next(t.slice(0,i.length));else i.forEach((s,a)=>{t[a].setPaths(s)})})}ngAfterViewInit(){var i;const t=T.map(null===(i=this.mapElement)||void 0===i?void 0:i.nativeElement).setView(U.E,U.T);T.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:18,minZoom:3,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(t);const s=T.geoJSON(void 0,{onEachFeature:(a,p)=>{p.on("click",r=>{this.showMoment(a.properties.id,r.latlng)})}});s.setStyle(a=>({color:(null==a?void 0:a.properties.color)||"#ffffff"})),this.geoJsonLayer$.next(s),s.addTo(t),this.map$.next(t)}showMoment(i,t){this.mappingItemModalService.showMappingItemByMovement(i,t).subscribe()}};M.\u0275fac=function(i){return new(i||M)(e.Y36(c.yh),e.Y36(de))},M.\u0275cmp=e.Xpm({type:M,selectors:[["app-map-view"]],viewQuery:function(i,t){if(1&i&&e.Gf(ue,5),2&i){let o;e.iGM(o=e.CRH())&&(t.mapElement=o.first)}},decls:9,vars:8,consts:[[1,"border","p-3","flex-grow-0"],["type","range","min","0",1,"slider",3,"max","ngModel","ngModelChange"],[1,"map-container","flex-grow-1"],[1,"map-frame"],[1,"map"],["map",""]],template:function(i,t){1&i&&(e.TgZ(0,"div",0),e.TgZ(1,"input",1),e.NdJ("ngModelChange",function(s){return t.timeRange=s}),e.qZA(),e._uU(2),e.ALo(3,"date"),e.ALo(4,"async"),e.qZA(),e.TgZ(5,"div",2),e.TgZ(6,"div",3),e._UZ(7,"div",4,5),e.qZA(),e.qZA()),2&i&&(e.xp6(1),e.Q6J("max",t.rangeSliderMax)("ngModel",t.timeRange),e.xp6(1),e.hij(" ",e.xi3(3,3,e.lcZ(4,6,t.currentTime$),"HH:mm dd-MM-YYYY"),"\n"))},directives:[Z.eT,Z.Fj,Z.JJ,Z.On],pipes:[l.uU,l.Ov],styles:["[_nghost-%COMP%]{height:100%;display:flex;flex-direction:column}.slider[_ngcontent-%COMP%]{width:100%}.map[_ngcontent-%COMP%]{width:100%;height:600px}.map-container[_ngcontent-%COMP%]{margin-right:15px}"],changeDetection:0}),M=(0,S.gn)([(0,x.c)()],M);const ve=[{path:"",component:(()=>{class n{constructor(){}ngOnInit(){}}return n.\u0275fac=function(t){return new(t||n)},n.\u0275cmp=e.Xpm({type:n,selectors:[["app-map-view-page"]],decls:1,vars:0,consts:[[1,"flex-grow-1","pb-1"]],template:function(t,o){1&t&&e._UZ(0,"app-map-view",0)},directives:[M],styles:["[_nghost-%COMP%]{display:flex;flex-direction:column;flex:1}"],changeDetection:0}),n})()}];let he=(()=>{class n{}return n.\u0275fac=function(t){return new(t||n)},n.\u0275mod=e.oAB({type:n}),n.\u0275inj=e.cJS({imports:[[F.Bz.forChild(ve)],F.Bz]}),n})();var R=m(8796),_=m(4741);let b=(()=>{class n{}return n.\u0275fac=function(t){return new(t||n)},n.\u0275mod=e.oAB({type:n}),n.\u0275inj=e.cJS({imports:[[l.ez,R.o,_.Y]]}),n})(),j=(()=>{class n{}return n.\u0275fac=function(t){return new(t||n)},n.\u0275mod=e.oAB({type:n}),n.\u0275inj=e.cJS({imports:[[l.ez,R.o,_.Y,b]]}),n})(),fe=(()=>{class n{}return n.\u0275fac=function(t){return new(t||n)},n.\u0275mod=e.oAB({type:n}),n.\u0275inj=e.cJS({imports:[[l.ez,b,j,_.Y]]}),n})(),Me=(()=>{class n{}return n.\u0275fac=function(t){return new(t||n)},n.\u0275mod=e.oAB({type:n}),n.\u0275inj=e.cJS({imports:[[l.ez,fe,b,j]]}),n})(),Ie=(()=>{class n{}return n.\u0275fac=function(t){return new(t||n)},n.\u0275mod=e.oAB({type:n}),n.\u0275inj=e.cJS({imports:[[l.ez,Z.u5,Z.UX,Me]]}),n})(),ye=(()=>{class n{}return n.\u0275fac=function(t){return new(t||n)},n.\u0275mod=e.oAB({type:n}),n.\u0275inj=e.cJS({imports:[[l.ez,he,Ie]]}),n})()}}]);