"use strict";(self.webpackChunkmap_observer=self.webpackChunkmap_observer||[]).push([[420],{5420:(Ce,$,p)=>{p.r($),p.d($,{MapViewPageModule:()=>Ie});var l=p(9808),F=p(3477),e=p(5e3),S=p(655),x=p(8407),b=p(2937),d=p(7319),I=p(561),y=p(1135),g=p(9841),H=p(4986),L=p(4482),_=p(5403),X=p(8421);const U={leading:!0,trailing:!1};var Q=p(5963);function B(n,o=H.z,t=U){const i=(0,Q.H)(n,o);return function z(n,{leading:o,trailing:t}=U){return(0,L.e)((i,s)=>{let a=!1,m=null,r=null,u=!1;const ye=()=>{null==r||r.unsubscribe(),r=null,t&&(j(),u&&s.complete())},we=()=>{r=null,u&&s.complete()},R=M=>r=(0,X.Xf)(n(M)).subscribe(new _.Q(s,ye,we)),j=()=>{if(a){a=!1;const M=m;m=null,s.next(M),!u&&R(M)}};i.subscribe(new _.Q(s,M=>{a=!0,m=M,(!r||r.closed)&&(o?j():R(M))},()=>{u=!0,(!(t&&a&&r)||r.closed)&&s.complete()}))})}(()=>i,t)}var D=p(7579),W=p(6063);class q extends D.x{constructor(o=1/0,t=1/0,i=W.l){super(),this._bufferSize=o,this._windowTime=t,this._timestampProvider=i,this._buffer=[],this._infiniteTimeWindow=!0,this._infiniteTimeWindow=t===1/0,this._bufferSize=Math.max(1,o),this._windowTime=Math.max(1,t)}next(o){const{isStopped:t,_buffer:i,_infiniteTimeWindow:s,_timestampProvider:a,_windowTime:m}=this;t||(i.push(o),!s&&i.push(a.now()+m)),this._trimBuffer(),super.next(o)}_subscribe(o){this._throwIfClosed(),this._trimBuffer();const t=this._innerSubscribe(o),{_infiniteTimeWindow:i,_buffer:s}=this,a=s.slice();for(let m=0;m<a.length&&!o.closed;m+=i?1:2)o.next(a[m]);return this._checkFinalizedStatuses(o),t}_trimBuffer(){const{_bufferSize:o,_timestampProvider:t,_buffer:i,_infiniteTimeWindow:s}=this,a=(s?1:2)*o;if(o<1/0&&a<i.length&&i.splice(0,i.length-a),!s){const m=t.now();let r=0;for(let u=1;u<i.length&&i[u]<=m;u+=2)r=u;r&&i.splice(0,r+1)}}}var G=p(3099);function J(n,o,t){var i,s;let a,m=!1;return n&&"object"==typeof n?(a=null!==(i=n.bufferSize)&&void 0!==i?i:1/0,o=null!==(s=n.windowTime)&&void 0!==s?s:1/0,m=!!n.refCount,t=n.scheduler):a=null!=n?n:1/0,(0,G.B)({connector:()=>new q(a,o,t),resetOnError:!0,resetOnComplete:!1,resetOnRefCountZero:m})}var V=p(9300),K=p(3900),c=p(4004),C=p(4987),O=p(1359),k=p(457),v=p(3125),ee=p(5698),Y=p(9889),Z=p(1205),te=p(914),ne=p(8726),ie=p(1829),oe=p(543);function se(n,o){if(1&n){const t=e.EpF();e.TgZ(0,"div",8),e._UZ(1,"app-asset-view",9),e.TgZ(2,"div",10),e.TgZ(3,"button",11),e.NdJ("click",function(){const a=e.CHM(t).$implicit;return e.oxw().editAsset(a)}),e._uU(4,"\u0440\u0435\u0434."),e.qZA(),e.TgZ(5,"button",12),e.NdJ("click",function(){const a=e.CHM(t).$implicit;return e.oxw().removeAsset(a.id)}),e._uU(6,"\u043f\u0440\u0438\u0431."),e.qZA(),e.qZA(),e.qZA()}if(2&n){const t=o.$implicit;e.xp6(1),e.Q6J("asset",t)}}function ae(n,o){if(1&n){const t=e.EpF();e.TgZ(0,"div",13),e._UZ(1,"app-asset-movement",14),e.TgZ(2,"div",15),e.TgZ(3,"button",11),e.NdJ("click",function(){const a=e.CHM(t).$implicit;return e.oxw().editMovement(a)}),e._uU(4,"\u0440\u0435\u0434."),e.qZA(),e.TgZ(5,"button",12),e.NdJ("click",function(){const a=e.CHM(t).$implicit;return e.oxw().removeMovement(a.id)}),e._uU(6,"\u043f\u0440\u0438\u0431. "),e.qZA(),e.qZA(),e.qZA()}if(2&n){const t=o.$implicit;e.xp6(1),e.Q6J("movement",t)}}let pe=(()=>{class n{constructor(t,i,s){this.store=t,this.assetFormModalService=i,this.movementFormModalService=s,this.mappingItem=void 0,this.assets=void 0,this.movements=void 0}ngOnInit(){}removeAsset(t){var i;t&&this.mappingItem&&(0,Z.n)(this.mappingItem)&&this.store.dispatch((0,v.XR)({assets:[t],mappingItem:null===(i=this.mappingItem)||void 0===i?void 0:i.id}))}removeMovement(t){var i;t&&this.mappingItem&&(0,Z.n)(this.mappingItem)&&this.store.dispatch((0,v.S4)({movements:[t],mappingItem:null===(i=this.mappingItem)||void 0===i?void 0:i.id}))}editAsset(t){this.assetFormModalService.editAsset(t).subscribe({next:i=>{this.store.dispatch((0,v.Oq)({assets:[i]}))},error:i=>{}})}editMovement(t){this.movementFormModalService.editMovement(t).subscribe({next:i=>{this.store.dispatch((0,v.hr)({movements:[i]}))},error:i=>{}})}selectAndAddAsset(){this.assetFormModalService.selectAsset().subscribe(t=>{var i;this.mappingItem&&(0,Z.n)(this.mappingItem)&&this.store.dispatch((0,v.Oq)({assets:t,mappingItem:null===(i=this.mappingItem)||void 0===i?void 0:i.id}))})}addNewAsset(){this.assetFormModalService.addAsset().subscribe(t=>{var i;this.mappingItem&&(0,Z.n)(this.mappingItem)&&this.store.dispatch((0,v.Oq)({assets:[t],mappingItem:null===(i=this.mappingItem)||void 0===i?void 0:i.id}))})}addNewMovement(){this.movementFormModalService.addMovement().subscribe({next:t=>{var i;this.mappingItem&&(0,Z.n)(this.mappingItem)&&this.store.dispatch((0,v.hr)({movements:[t],mappingItem:null===(i=this.mappingItem)||void 0===i?void 0:i.id}))},error:t=>{}})}}return n.\u0275fac=function(t){return new(t||n)(e.Y36(d.yh),e.Y36(te.r),e.Y36(ne.a))},n.\u0275cmp=e.Xpm({type:n,selectors:[["app-mapping-item"]],inputs:{mappingItem:"mappingItem",assets:"assets",movements:"movements"},decls:20,vars:3,consts:[[1,"border","p-1"],[1,"assets-container","container"],["class","row border",4,"ngFor","ngForOf"],[1,"d-flex","flex-row"],[1,"btn","btn-outline-primary","flex-grow-0",3,"click"],[1,"btn","btn-outline-secondary","flex-grow-0",3,"click"],[1,"movements-container","container"],["class","row border p-1",4,"ngFor","ngForOf"],[1,"row","border"],[1,"col-md-10",3,"asset"],[1,"col-md-2"],[1,"btn","btn-link","flex-grow-0",3,"click"],[1,"btn","btn-link","flex-grow-0","text-danger",3,"click"],[1,"row","border","p-1"],[1,"flex-grow-1","col-md-10",3,"movement"],[1,"flex-grow-0","col-md-2"]],template:function(t,i){1&t&&(e.TgZ(0,"div",0),e._uU(1),e.qZA(),e.TgZ(2,"div",0),e.TgZ(3,"h4"),e._uU(4,"\u0410\u043a\u0442\u0438\u0432\u0438"),e.qZA(),e.TgZ(5,"div",1),e.YNc(6,se,7,1,"div",2),e.qZA(),e.TgZ(7,"div",3),e.TgZ(8,"button",4),e.NdJ("click",function(){return i.selectAndAddAsset()}),e._uU(9,"\u0434\u043e\u0434\u0430\u0442\u0438 \u0456\u0441\u043d\u0443\u044e\u0447\u0438\u0439"),e.qZA(),e.TgZ(10,"button",5),e.NdJ("click",function(){return i.addNewAsset()}),e._uU(11,"\u0441\u0442\u0432\u043e\u0440\u0438\u0442\u0438 \u043d\u043e\u0432\u0438\u0439 "),e.qZA(),e.qZA(),e.qZA(),e.TgZ(12,"div",0),e.TgZ(13,"h4"),e._uU(14,"\u041f\u043e\u0437\u0438\u0446\u0456\u0457"),e.qZA(),e.TgZ(15,"div",6),e.YNc(16,ae,7,1,"div",7),e.qZA(),e.TgZ(17,"div",3),e.TgZ(18,"button",5),e.NdJ("click",function(){return i.addNewMovement()}),e._uU(19,"\u0441\u0442\u0432\u043e\u0440\u0438\u0442\u0438 \u043d\u043e\u0432\u0438\u0439 "),e.qZA(),e.qZA(),e.qZA()),2&t&&(e.xp6(1),e.Oqu(null==i.mappingItem?null:i.mappingItem.description),e.xp6(5),e.Q6J("ngForOf",i.assets),e.xp6(10),e.Q6J("ngForOf",i.movements))},directives:[l.sg,ie.F,oe.W],styles:[".assets-container[_ngcontent-%COMP%], .movements-container[_ngcontent-%COMP%]{max-height:300px;overflow:auto;overflow-x:hidden}"],changeDetection:0}),n})();function me(n,o){if(1&n&&(e._UZ(0,"app-mapping-item",1),e.ALo(1,"async"),e.ALo(2,"async")),2&n){const t=o.ngIf,i=e.oxw();e.Q6J("mappingItem",t)("assets",e.lcZ(1,3,i.assets$))("movements",e.lcZ(2,5,i.movements$))}}let re=(()=>{class n{constructor(t){this.store=t,this._id=new y.X(void 0),this.mappingItem$=(0,g.a)([this._id,this.store.pipe((0,d.Ys)(I.q.selectItemsEntities))]).pipe((0,c.U)(([i,s])=>i?s[i]:void 0)),this.assets$=(0,g.a)([this.mappingItem$,this.store.pipe((0,d.Ys)(I.q.selectAssetsEntities))]).pipe((0,c.U)(([i,s])=>{var a;return(null===(a=null==i?void 0:i.assets)||void 0===a?void 0:a.map(m=>s[m]))||[]})),this.movements$=(0,g.a)([this.mappingItem$,this.store.pipe((0,d.Ys)(I.q.selectAssetMovementsEntities))]).pipe((0,c.U)(([i,s])=>{var a;return(null===(a=null==i?void 0:i.movements)||void 0===a?void 0:a.map(m=>s[m]))||[]}))}set id(t){this._id.next(t)}get id(){return this._id.value}ngOnInit(){}}return n.\u0275fac=function(t){return new(t||n)(e.Y36(d.yh))},n.\u0275cmp=e.Xpm({type:n,selectors:[["app-mapping-item-standalone"]],inputs:{id:"id"},decls:2,vars:3,consts:[[3,"mappingItem","assets","movements",4,"ngIf"],[3,"mappingItem","assets","movements"]],template:function(t,i){1&t&&(e.YNc(0,me,3,7,"app-mapping-item",0),e.ALo(1,"async")),2&t&&e.Q6J("ngIf",e.lcZ(1,1,i.mappingItem$))},directives:[l.O5,pe],pipes:[l.Ov],styles:[""],changeDetection:0}),n})();function le(n,o){1&n&&e._UZ(0,"app-mapping-item-standalone",7),2&n&&e.Q6J("id",o.ngIf)}let h=class{constructor(o,t){this.activeModal=o,this.store=t,this._movementId=new y.X(void 0),this.itemIdByMovement$=this.store.pipe((0,d.Ys)(I.q.selectItemIdByMovement)),this.selectedItemId$=(0,g.a)([this._movementId,this.itemIdByMovement$]).pipe((0,c.U)(([i,s])=>i?s[i]:void 0))}set movementId(o){this._movementId.next(o)}get movementId(){return this._movementId.value}ngOnInit(){}deleteItem(){this.selectedItemId$.pipe((0,ee.q)(1),(0,C.t)(this)).subscribe(o=>{o&&this.store.dispatch((0,v.UA)({ids:[o]}))})}onCancel(){this.activeModal.dismiss()}};h.\u0275fac=function(o){return new(o||h)(e.Y36(Y.Kz),e.Y36(d.yh))},h.\u0275cmp=e.Xpm({type:h,selectors:[["app-mapping-item-modal"]],inputs:{movementId:"movementId"},decls:11,vars:3,consts:[[1,"modal-header"],[1,"modal-title"],[1,"modal-body"],[1,"text-secondary"],[3,"id",4,"ngIf"],[1,"modal-footer"],["type","button",1,"btn","btn-link",3,"click"],[3,"id"]],template:function(o,t){1&o&&(e.TgZ(0,"div",0),e.TgZ(1,"h4",1),e.TgZ(2,"span"),e._uU(3," \u041e\u0431\u0440\u0430\u043d\u043e \u0437\u0430\u043f\u0438\u0441 "),e.qZA(),e.qZA(),e.qZA(),e.TgZ(4,"div",2),e._UZ(5,"div",3),e.YNc(6,le,1,1,"app-mapping-item-standalone",4),e.ALo(7,"async"),e.qZA(),e.TgZ(8,"div",5),e.TgZ(9,"button",6),e.NdJ("click",function(){return t.onCancel()}),e._uU(10," \u0437\u0430\u043a\u0440\u0438\u0442\u0438 "),e.qZA(),e.qZA()),2&o&&(e.xp6(6),e.Q6J("ngIf",e.lcZ(7,1,t.selectedItemId$)))},directives:[l.O5,re],pipes:[l.Ov],styles:[""],changeDetection:0}),h=(0,S.gn)([(0,C.c)()],h);let de=(()=>{class n{constructor(t,i){this.modalService=t,this.store=i,this.openedModal=null}showMappingItemByMovement(t){var i;return null===(i=this.openedModal)||void 0===i||i.close(),this.openedModal=this.modalService.open(h,{keyboard:!1,backdrop:"static",size:"lg"}),this.openedModal.componentInstance.movementId=t,(0,k.D)(this.openedModal.result)}addNewItem(){}}return n.\u0275fac=function(t){return new(t||n)(e.LFG(Y.FF),e.LFG(d.yh))},n.\u0275prov=e.Yz7({token:n,factory:n.\u0275fac,providedIn:"root"}),n})();var w=p(2382);const ce=["map"],T=36e5;let f=class{constructor(o,t){this.store=o,this.mappingItemModalService=t,this.rangeSliderMax=5e3,this.movements$=this.store.pipe((0,d.Ys)(I.q.selectAssetMovementsAll)),this.movementsTimeRange$=this.store.pipe((0,d.Ys)(I.q.selectAssetMovementsTimeRange)),this._timeRange=new y.X(0),this.currentTime$=(0,g.a)([this._timeRange.pipe(B(50)),this.movementsTimeRange$]).pipe((0,c.U)(([i,s])=>s.start+Math.floor((s.end-s.start)*i/this.rangeSliderMax)),J({bufferSize:1,refCount:!0})),this.currentMovements$=(0,g.a)([this.movements$,this.currentTime$]).pipe((0,c.U)(([i,s])=>i.filter(a=>function ue(n,o){return n.start<=o&&n.end>=o||n.start>=o-T&&n.start<=o+T||n.end>=o-T&&n.end<=o+T}(a,s))),J({bufferSize:1,refCount:!0})),this.geoValue$=this.currentMovements$.pipe((0,c.U)(i=>({type:"FeatureCollection",features:i.map(s=>Object.assign(Object.assign({},s.geo),{properties:{id:s.id}}))}))),this.arrowHeadsLayer$=new y.X([]),this.arrowHeadsLines$=this.geoValue$.pipe((0,c.U)(i=>(0,O.UW)(i.features))),this.map$=new y.X(null),this.geoJsonLayer$=new y.X(null)}set timeRange(o){this._timeRange.next(o)}get timeRange(){return this._timeRange.value}addItem(){}ngOnInit(){(0,g.a)([this.geoValue$,this.geoJsonLayer$,this.map$]).pipe((0,V.h)(([o,t,i])=>!!t&&!!i),(0,C.t)(this)).subscribe(([o,t,i])=>{null==t||t.clearLayers(),o&&(null==t||t.addData(o))}),this.map$.pipe((0,V.h)(o=>!!o),(0,K.w)(o=>(0,g.a)([this.arrowHeadsLines$,this.arrowHeadsLayer$]).pipe((0,c.U)(([t,i])=>({lines:t,heads:i,mapObj:o})))),(0,C.t)(this)).subscribe(({lines:o,heads:t,mapObj:i})=>{if(i)if(t.length!==o.length)if(t.length<o.length){const s=Array.from(Array(o.length-t.length)).map((a,m)=>(0,O.Cl)(i));this.arrowHeadsLayer$.next([...t,...s])}else t.slice(o.length).forEach(s=>{s.remove()}),this.arrowHeadsLayer$.next(t.slice(0,o.length));else o.forEach((s,a)=>{t[a].setPaths(s)})})}ngAfterViewInit(){var o;const t=x.map(null===(o=this.mapElement)||void 0===o?void 0:o.nativeElement).setView(b.E,b.T);x.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:18,minZoom:3,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(t);const s=x.geoJSON(void 0,{onEachFeature:(a,m)=>{m.on("click",r=>{this.showMoment(a.properties.id)})}});s.setStyle(a=>({color:(null==a?void 0:a.properties.color)||"#ffffff"})),this.geoJsonLayer$.next(s),s.addTo(t),this.map$.next(t)}showMoment(o){this.mappingItemModalService.showMappingItemByMovement(o).subscribe()}};f.\u0275fac=function(o){return new(o||f)(e.Y36(d.yh),e.Y36(de))},f.\u0275cmp=e.Xpm({type:f,selectors:[["app-map-view"]],viewQuery:function(o,t){if(1&o&&e.Gf(ce,5),2&o){let i;e.iGM(i=e.CRH())&&(t.mapElement=i.first)}},decls:9,vars:8,consts:[[1,"border","p-3","flex-grow-0"],["type","range","min","0",1,"slider",3,"max","ngModel","ngModelChange"],[1,"map-container","flex-grow-1"],[1,"map-frame"],[1,"map"],["map",""]],template:function(o,t){1&o&&(e.TgZ(0,"div",0),e.TgZ(1,"input",1),e.NdJ("ngModelChange",function(s){return t.timeRange=s}),e.qZA(),e._uU(2),e.ALo(3,"date"),e.ALo(4,"async"),e.qZA(),e.TgZ(5,"div",2),e.TgZ(6,"div",3),e._UZ(7,"div",4,5),e.qZA(),e.qZA()),2&o&&(e.xp6(1),e.Q6J("max",t.rangeSliderMax)("ngModel",t.timeRange),e.xp6(1),e.hij(" ",e.xi3(3,3,e.lcZ(4,6,t.currentTime$),"HH:mm dd-MM-YYYY"),"\n"))},directives:[w.eT,w.Fj,w.JJ,w.On],pipes:[l.uU,l.Ov],styles:["[_nghost-%COMP%]{height:100%;display:flex;flex-direction:column}.slider[_ngcontent-%COMP%]{width:100%}.map[_ngcontent-%COMP%]{width:100%;height:600px}.map-container[_ngcontent-%COMP%]{margin-right:15px}"],changeDetection:0}),f=(0,S.gn)([(0,C.c)()],f);const ge=[{path:"",component:(()=>{class n{constructor(){}ngOnInit(){}}return n.\u0275fac=function(t){return new(t||n)},n.\u0275cmp=e.Xpm({type:n,selectors:[["app-map-view-page"]],decls:1,vars:0,consts:[[1,"flex-grow-1","pb-1"]],template:function(t,i){1&t&&e._UZ(0,"app-map-view",0)},directives:[f],styles:["[_nghost-%COMP%]{display:flex;flex-direction:column;flex:1}"],changeDetection:0}),n})()}];let ve=(()=>{class n{}return n.\u0275fac=function(t){return new(t||n)},n.\u0275mod=e.oAB({type:n}),n.\u0275inj=e.cJS({imports:[[F.Bz.forChild(ge)],F.Bz]}),n})();var E=p(8796),P=p(4741);let A=(()=>{class n{}return n.\u0275fac=function(t){return new(t||n)},n.\u0275mod=e.oAB({type:n}),n.\u0275inj=e.cJS({imports:[[l.ez,E.o,P.Y]]}),n})(),N=(()=>{class n{}return n.\u0275fac=function(t){return new(t||n)},n.\u0275mod=e.oAB({type:n}),n.\u0275inj=e.cJS({imports:[[l.ez,E.o,P.Y,A]]}),n})(),he=(()=>{class n{}return n.\u0275fac=function(t){return new(t||n)},n.\u0275mod=e.oAB({type:n}),n.\u0275inj=e.cJS({imports:[[l.ez,A,N]]}),n})(),fe=(()=>{class n{}return n.\u0275fac=function(t){return new(t||n)},n.\u0275mod=e.oAB({type:n}),n.\u0275inj=e.cJS({imports:[[l.ez,he,A,N]]}),n})(),Me=(()=>{class n{}return n.\u0275fac=function(t){return new(t||n)},n.\u0275mod=e.oAB({type:n}),n.\u0275inj=e.cJS({imports:[[l.ez,w.u5,w.UX,fe]]}),n})(),Ie=(()=>{class n{}return n.\u0275fac=function(t){return new(t||n)},n.\u0275mod=e.oAB({type:n}),n.\u0275inj=e.cJS({imports:[[l.ez,ve,Me]]}),n})()}}]);