"use strict";(self.webpackChunkmap_observer=self.webpackChunkmap_observer||[]).push([[108],{6108:($e,E,r)=>{r.r(E),r.d(E,{MapViewPageModule:()=>Fe});var p=r(9808),V=r(3007),e=r(5e3),y=r(655),R=r(8407),O=r(2937),c=r(7319),M=r(561),d=r(1135),A=r(3900),f=r(9841),Q=r(4986),L=r(4482),z=r(8421),q=r(5403),G=r(5963);function K(i,n=Q.P){return function W(i){return(0,L.e)((n,t)=>{let o=!1,s=null,a=null,l=!1;const Z=()=>{if(null==a||a.unsubscribe(),a=null,o){o=!1;const S=s;s=null,t.next(S)}l&&t.complete()},w=()=>{a=null,l&&t.complete()};n.subscribe(new q.Q(t,S=>{o=!0,s=S,a||(0,z.Xf)(i(S)).subscribe(a=new q.Q(t,Z,w))},()=>{l=!0,(!o||!a||a.closed)&&t.complete()}))})}(()=>(0,G.H)(i,n))}var ee=r(7579),te=r(6063);class ne extends ee.x{constructor(n=1/0,t=1/0,o=te.l){super(),this._bufferSize=n,this._windowTime=t,this._timestampProvider=o,this._buffer=[],this._infiniteTimeWindow=!0,this._infiniteTimeWindow=t===1/0,this._bufferSize=Math.max(1,n),this._windowTime=Math.max(1,t)}next(n){const{isStopped:t,_buffer:o,_infiniteTimeWindow:s,_timestampProvider:a,_windowTime:l}=this;t||(o.push(n),!s&&o.push(a.now()+l)),this._trimBuffer(),super.next(n)}_subscribe(n){this._throwIfClosed(),this._trimBuffer();const t=this._innerSubscribe(n),{_infiniteTimeWindow:o,_buffer:s}=this,a=s.slice();for(let l=0;l<a.length&&!n.closed;l+=o?1:2)n.next(a[l]);return this._checkFinalizedStatuses(n),t}_trimBuffer(){const{_bufferSize:n,_timestampProvider:t,_buffer:o,_infiniteTimeWindow:s}=this,a=(s?1:2)*n;if(n<1/0&&a<o.length&&o.splice(0,o.length-a),!s){const l=t.now();let Z=0;for(let w=1;w<o.length&&o[w]<=l;w+=2)Z=w;Z&&o.splice(0,Z+1)}}}var ie=r(3099);function N(i,n,t){var o,s;let a,l=!1;return i&&"object"==typeof i?(a=null!==(o=i.bufferSize)&&void 0!==o?o:1/0,n=null!==(s=i.windowTime)&&void 0!==s?s:1/0,l=!!i.refCount,t=i.scheduler):a=null!=i?i:1/0,(0,ie.B)({connector:()=>new ne(a,n,t),resetOnError:!0,resetOnComplete:!1,resetOnRefCountZero:l})}var oe=r(9300),u=r(4004),g=r(4987),D=r(1359),v=r(3897),se=r(457),h=r(3125),Y=r(5698),b=r(9889),P=r(9792),B=r(543),x=r(1205),ae=r(914),re=r(1829);function le(i,n){if(1&i){const t=e.EpF();e.TgZ(0,"div",8),e._UZ(1,"app-asset-view",9),e.TgZ(2,"div",10),e.TgZ(3,"button",11),e.NdJ("click",function(){const a=e.CHM(t).$implicit;return e.oxw().editAsset(a)}),e._uU(4,"\u0440\u0435\u0434."),e.qZA(),e.TgZ(5,"button",12),e.NdJ("click",function(){const a=e.CHM(t).$implicit;return e.oxw().removeAsset(a.id)}),e._uU(6,"\u043f\u0440\u0438\u0431."),e.qZA(),e.qZA(),e.qZA()}if(2&i){const t=n.$implicit;e.xp6(1),e.Q6J("asset",t)}}function me(i,n){if(1&i){const t=e.EpF();e.TgZ(0,"div",13),e._UZ(1,"app-asset-movement",14),e.TgZ(2,"div",15),e.TgZ(3,"button",11),e.NdJ("click",function(){const a=e.CHM(t).$implicit;return e.oxw().editMovement(a)}),e._uU(4,"\u0440\u0435\u0434."),e.qZA(),e.TgZ(5,"button",12),e.NdJ("click",function(){const a=e.CHM(t).$implicit;return e.oxw().removeMovement(a.id)}),e._uU(6,"\u043f\u0440\u0438\u0431. "),e.qZA(),e.qZA(),e.qZA()}if(2&i){const t=n.$implicit;e.xp6(1),e.Q6J("movement",t)}}let pe=(()=>{class i{constructor(t,o,s){this.store=t,this.assetFormModalService=o,this.movementFormModalService=s,this.mappingItem=void 0,this.assets=void 0,this.movements=void 0}ngOnInit(){}removeAsset(t){var o;t&&this.mappingItem&&(0,x.n)(this.mappingItem)&&this.store.dispatch((0,h.XR)({assets:[t],mappingItem:null===(o=this.mappingItem)||void 0===o?void 0:o.id}))}removeMovement(t){var o;t&&this.mappingItem&&(0,x.n)(this.mappingItem)&&this.store.dispatch((0,h.S4)({movements:[t],mappingItem:null===(o=this.mappingItem)||void 0===o?void 0:o.id}))}editAsset(t){this.assetFormModalService.editAsset(t).subscribe({next:o=>{this.store.dispatch((0,h.Oq)({assets:[o]}))},error:o=>{}})}editMovement(t){this.movementFormModalService.editMovement(t).subscribe({next:o=>{this.store.dispatch((0,h.hr)({movements:[o]}))},error:o=>{}})}selectAndAddAsset(){this.assetFormModalService.selectAsset().subscribe(t=>{var o;this.mappingItem&&(0,x.n)(this.mappingItem)&&this.store.dispatch((0,h.Oq)({assets:t,mappingItem:null===(o=this.mappingItem)||void 0===o?void 0:o.id}))})}addNewAsset(){this.assetFormModalService.addAsset().subscribe(t=>{var o;this.mappingItem&&(0,x.n)(this.mappingItem)&&this.store.dispatch((0,h.Oq)({assets:[t],mappingItem:null===(o=this.mappingItem)||void 0===o?void 0:o.id}))})}addNewMovement(){this.movementFormModalService.addMovement().subscribe({next:t=>{var o;this.mappingItem&&(0,x.n)(this.mappingItem)&&this.store.dispatch((0,h.hr)({movements:[t],mappingItem:null===(o=this.mappingItem)||void 0===o?void 0:o.id}))},error:t=>{}})}}return i.\u0275fac=function(t){return new(t||i)(e.Y36(c.yh),e.Y36(ae.r),e.Y36(P.a))},i.\u0275cmp=e.Xpm({type:i,selectors:[["app-mapping-item"]],inputs:{mappingItem:"mappingItem",assets:"assets",movements:"movements"},decls:20,vars:3,consts:[[1,"border","p-1"],[1,"assets-container","container"],["class","row border",4,"ngFor","ngForOf"],[1,"d-flex","flex-row"],[1,"btn","btn-outline-primary","flex-grow-0",3,"click"],[1,"btn","btn-outline-secondary","flex-grow-0",3,"click"],[1,"movements-container","container"],["class","row border p-1",4,"ngFor","ngForOf"],[1,"row","border"],[1,"col-md-10",3,"asset"],[1,"col-md-2"],[1,"btn","btn-link","flex-grow-0",3,"click"],[1,"btn","btn-link","flex-grow-0","text-danger",3,"click"],[1,"row","border","p-1"],[1,"flex-grow-1","col-md-10",3,"movement"],[1,"flex-grow-0","col-md-2"]],template:function(t,o){1&t&&(e.TgZ(0,"div",0),e._uU(1),e.qZA(),e.TgZ(2,"div",0),e.TgZ(3,"h4"),e._uU(4,"\u0410\u043a\u0442\u0438\u0432\u0438"),e.qZA(),e.TgZ(5,"div",1),e.YNc(6,le,7,1,"div",2),e.qZA(),e.TgZ(7,"div",3),e.TgZ(8,"button",4),e.NdJ("click",function(){return o.selectAndAddAsset()}),e._uU(9,"\u0434\u043e\u0434\u0430\u0442\u0438 \u0456\u0441\u043d\u0443\u044e\u0447\u0438\u0439"),e.qZA(),e.TgZ(10,"button",5),e.NdJ("click",function(){return o.addNewAsset()}),e._uU(11,"\u0441\u0442\u0432\u043e\u0440\u0438\u0442\u0438 \u043d\u043e\u0432\u0438\u0439 "),e.qZA(),e.qZA(),e.qZA(),e.TgZ(12,"div",0),e.TgZ(13,"h4"),e._uU(14,"\u041f\u043e\u0437\u0438\u0446\u0456\u0457"),e.qZA(),e.TgZ(15,"div",6),e.YNc(16,me,7,1,"div",7),e.qZA(),e.TgZ(17,"div",3),e.TgZ(18,"button",5),e.NdJ("click",function(){return o.addNewMovement()}),e._uU(19,"\u0441\u0442\u0432\u043e\u0440\u0438\u0442\u0438 \u043d\u043e\u0432\u0438\u0439 "),e.qZA(),e.qZA(),e.qZA()),2&t&&(e.xp6(1),e.Oqu(null==o.mappingItem?null:o.mappingItem.description),e.xp6(5),e.Q6J("ngForOf",o.assets),e.xp6(10),e.Q6J("ngForOf",o.movements))},directives:[p.sg,re.F,B.W],styles:[".assets-container[_ngcontent-%COMP%], .movements-container[_ngcontent-%COMP%]{max-height:300px;overflow:auto;overflow-x:hidden}"],changeDetection:0}),i})();function ue(i,n){if(1&i&&(e._UZ(0,"app-mapping-item",1),e.ALo(1,"async"),e.ALo(2,"async")),2&i){const t=n.ngIf,o=e.oxw();e.Q6J("mappingItem",t)("assets",e.lcZ(1,3,o.assets$))("movements",e.lcZ(2,5,o.movements$))}}let ce=(()=>{class i{constructor(t){this.store=t,this._id=new d.X(void 0),this.mappingItem$=(0,f.a)([this._id,this.store.pipe((0,c.Ys)(M.q.selectItemsEntities))]).pipe((0,u.U)(([o,s])=>o?s[o]:void 0)),this.assets$=(0,f.a)([this.mappingItem$,this.store.pipe((0,c.Ys)(M.q.selectAssetsEntities))]).pipe((0,u.U)(([o,s])=>{var a;return(null===(a=null==o?void 0:o.assets)||void 0===a?void 0:a.map(l=>s[l]))||[]})),this.movements$=(0,f.a)([this.mappingItem$,this.store.pipe((0,c.Ys)(M.q.selectAssetMovementsEntities))]).pipe((0,u.U)(([o,s])=>{var a;return(null===(a=null==o?void 0:o.movements)||void 0===a?void 0:a.map(l=>s[l]))||[]}))}set id(t){this._id.next(t)}get id(){return this._id.value}ngOnInit(){}}return i.\u0275fac=function(t){return new(t||i)(e.Y36(c.yh))},i.\u0275cmp=e.Xpm({type:i,selectors:[["app-mapping-item-standalone"]],inputs:{id:"id"},decls:2,vars:3,consts:[[3,"mappingItem","assets","movements",4,"ngIf"],[3,"mappingItem","assets","movements"]],template:function(t,o){1&t&&(e.YNc(0,ue,3,7,"app-mapping-item",0),e.ALo(1,"async")),2&t&&e.Q6J("ngIf",e.lcZ(1,1,o.mappingItem$))},directives:[p.O5,pe],pipes:[p.Ov],styles:[""],changeDetection:0}),i})();function de(i,n){if(1&i){const t=e.EpF();e.TgZ(0,"section",4),e._UZ(1,"app-asset-movement",8),e.TgZ(2,"button",9),e.NdJ("click",function(){const a=e.CHM(t).ngIf;return e.oxw().editMovement(a)}),e._uU(3,"\u0440\u0435\u0434."),e.qZA(),e.TgZ(4,"button",10),e.NdJ("click",function(){const a=e.CHM(t).ngIf;return e.oxw().removeMovement(a.id)}),e._uU(5,"\u043f\u0440\u0438\u0431."),e.qZA(),e.qZA()}if(2&i){const t=n.ngIf,o=e.oxw();e.xp6(1),e.Q6J("movement",t)("selectedPosition",o.selectedPosition)}}function ge(i,n){1&i&&e._UZ(0,"app-mapping-item-standalone",11),2&i&&e.Q6J("id",n.ngIf)}let _=class{constructor(n,t,o){this.activeModal=n,this.store=t,this.movementFormModalService=o,this._movementId=new d.X(void 0),this.movements$=this.store.pipe((0,c.Ys)(M.q.selectAssetMovementsEntities)),this.movement$=(0,f.a)([this._movementId,this.movements$]).pipe((0,u.U)(([s,a])=>!!s&&a[s]||null)),this.itemIdByMovement$=this.store.pipe((0,c.Ys)(M.q.selectItemIdByMovement)),this.selectedItemId$=(0,f.a)([this._movementId,this.itemIdByMovement$]).pipe((0,u.U)(([s,a])=>s?a[s]:void 0))}set movementId(n){this._movementId.next(n)}get movementId(){return this._movementId.value}ngOnInit(){}deleteItem(){this.selectedItemId$.pipe((0,Y.q)(1),(0,g.t)(this)).subscribe(n=>{n&&this.store.dispatch((0,h.UA)({ids:[n]}))})}onCancel(){this.activeModal.dismiss()}editMovement(n){this.movementFormModalService.editMovement(n).subscribe({next:t=>{this.store.dispatch((0,h.hr)({movements:[t]}))},error:t=>{}})}removeMovement(n){this.selectedItemId$.pipe((0,Y.q)(1)).subscribe(t=>{n&&t&&this.store.dispatch((0,h.S4)({movements:[n],mappingItem:t}))})}};_.\u0275fac=function(n){return new(n||_)(e.Y36(b.Kz),e.Y36(c.yh),e.Y36(P.a))},_.\u0275cmp=e.Xpm({type:_,selectors:[["app-mapping-item-modal"]],inputs:{movementId:"movementId",selectedPosition:"selectedPosition"},decls:15,vars:6,consts:[[1,"modal-header"],[1,"modal-title"],[1,"modal-body"],["class","my-sm-2 p-2 border",4,"ngIf"],[1,"my-sm-2","p-2","border"],[3,"id",4,"ngIf"],[1,"modal-footer"],["type","button",1,"btn","btn-link",3,"click"],[3,"movement","selectedPosition"],[1,"btn","btn-link",3,"click"],[1,"btn","btn-link","text-danger",3,"click"],[3,"id"]],template:function(n,t){1&n&&(e.TgZ(0,"div",0),e.TgZ(1,"h4",1),e.TgZ(2,"span"),e._uU(3," \u041e\u0431\u0440\u0430\u043d\u0430 \u043f\u043e\u0437\u0438\u0446\u0456\u044f "),e.qZA(),e.qZA(),e.qZA(),e.TgZ(4,"div",2),e.YNc(5,de,6,2,"section",3),e.ALo(6,"async"),e.TgZ(7,"section",4),e.TgZ(8,"h5"),e._uU(9,"\u0410\u0441\u043e\u0446\u0456\u0439\u043e\u0432\u0430\u043d\u0438\u0439 \u0437\u0430\u043f\u0438\u0441"),e.qZA(),e.YNc(10,ge,1,1,"app-mapping-item-standalone",5),e.ALo(11,"async"),e.qZA(),e.qZA(),e.TgZ(12,"div",6),e.TgZ(13,"button",7),e.NdJ("click",function(){return t.onCancel()}),e._uU(14," \u0437\u0430\u043a\u0440\u0438\u0442\u0438 "),e.qZA(),e.qZA()),2&n&&(e.xp6(5),e.Q6J("ngIf",e.lcZ(6,2,t.movement$)),e.xp6(5),e.Q6J("ngIf",e.lcZ(11,4,t.selectedItemId$)))},directives:[p.O5,B.W,ce],pipes:[p.Ov],styles:[""],changeDetection:0}),_=(0,y.gn)([(0,g.c)()],_);let ve=(()=>{class i{constructor(t,o){this.modalService=t,this.store=o,this.openedModal=null}showMappingItemByMovement(t,o){var s;null===(s=this.openedModal)||void 0===s||s.close(),this.openedModal=this.modalService.open(_,{keyboard:!1,backdrop:"static",size:"lg"});const a=this.openedModal.componentInstance;return a.movementId=t,a.selectedPosition=(0,D.pc)(o),(0,se.D)(this.openedModal.result)}addNewItem(){}}return i.\u0275fac=function(t){return new(t||i)(e.LFG(b.FF),e.LFG(c.yh))},i.\u0275prov=e.Yz7({token:i,factory:i.\u0275fac,providedIn:"root"}),i})();var F,m=r(2382),k=r(9761),he=r(3607);let T=F=class extends k.H{constructor(n){super(n),this.availableRange={start:(new Date).getTime(),end:(new Date).getTime()},this._timeRange=new d.X(0),this.rangeSliderMax=5e3}set timeRange(n){this._timeRange.next(n)}get timeRange(){return this._timeRange.value}ngOnInit(){this._timeRange.pipe((0,g.t)(this)).subscribe(n=>{this.setCurrentValue(n)})}ngOnChanges(n){n.availableRange&&this.setCurrentValue(this.timeRange)}setCurrentValue(n){var t,o;this.value=function fe(i,n,t,o){return t+Math.floor((o-t)*i/n)}(n,this.rangeSliderMax,(null===(t=this.availableRange)||void 0===t?void 0:t.start)||0,(null===(o=this.availableRange)||void 0===o?void 0:o.end)||0)}writeValue(n){var t,o;super.writeValue(n),this.timeRange=(0,he.Z)(n)?function Me(i,n,t,o){return o===t?0:Math.min(n,Math.floor(Math.max(i-t,0)*n/(o-t)))}(n,this.rangeSliderMax,(null===(t=this.availableRange)||void 0===t?void 0:t.start)||0,(null===(o=this.availableRange)||void 0===o?void 0:o.end)||0):0}};var $;T.\u0275fac=function(n){return new(n||T)(e.Y36(e.sBO))},T.\u0275cmp=e.Xpm({type:T,selectors:[["app-time-range-select"]],inputs:{availableRange:"availableRange"},features:[e._Bn([{provide:m.JU,useExisting:(0,e.Gpc)(()=>F),multi:!0}]),e.qOj,e.TTD],decls:1,vars:2,consts:[["type","range","min","0",1,"slider",3,"max","ngModel","ngModelChange"]],template:function(n,t){1&n&&(e.TgZ(0,"input",0),e.NdJ("ngModelChange",function(s){return t.timeRange=s}),e.qZA()),2&n&&e.Q6J("max",t.rangeSliderMax)("ngModel",t.timeRange)},directives:[m.eT,m.Fj,m.JJ,m.On],styles:[".slider[_ngcontent-%COMP%]{width:100%}"],changeDetection:0}),T=F=(0,y.gn)([(0,g.c)()],T);let I=$=class extends k.H{constructor(n,t){super(n),this.formBuilder=t,this.availableRange={start:(new Date).getTime(),end:(new Date).getTime()},this.form=this.formBuilder.group({})}ngOnInit(){var n;this.buildForm(),null===(n=this.form.get("startDate"))||void 0===n||n.valueChanges.pipe((0,g.t)(this)).subscribe(t=>{const o=(0,v.wG)(t,"23:59")||new Date;this.form.patchValue({endDate:(0,v.yq)(o.getTime())})}),this.form.valueChanges.pipe((0,g.t)(this)).subscribe(t=>{const o=!!t.startDate&&(0,v.wG)(t.startDate,"00:00")||new Date,s=!!t.endDate&&(0,v.wG)(t.endDate,"23:59")||new Date;this.value={start:null==o?void 0:o.getTime(),end:null==s?void 0:s.getTime()}})}ngOnChanges(n){}writeValue(n){super.writeValue(n),n&&this.form.patchValue({startDate:(0,v.yq)((null==n?void 0:n.start)||0),endDate:(0,v.yq)((null==n?void 0:n.end)||0)})}buildForm(){var n,t;this.form=this.formBuilder.group({startDate:[(0,v.yq)((null===(n=this.value)||void 0===n?void 0:n.start)||0)||null,m.kI.required],endDate:[(0,v.yq)((null===(t=this.value)||void 0===t?void 0:t.end)||0)||null]})}};I.\u0275fac=function(n){return new(n||I)(e.Y36(e.sBO),e.Y36(m.qu))},I.\u0275cmp=e.Xpm({type:I,selectors:[["app-date-range-selector"]],inputs:{availableRange:"availableRange"},features:[e._Bn([{provide:m.JU,useExisting:(0,e.Gpc)(()=>$),multi:!0}]),e.qOj,e.TTD],decls:9,vars:1,consts:[["novalidate","",3,"formGroup"],[1,"me-1"],["placeholder","\u0440\u0456\u043a-\u043c\u0456\u0441\u044f\u0446-\u0434\u0435\u043d\u044c","formControlName","startDate","type","text","ngbDatepicker","",3,"click"],["startDate","ngbDatepicker"],[1,"me-1","ms-2"],["placeholder","\u0440\u0456\u043a-\u043c\u0456\u0441\u044f\u0446-\u0434\u0435\u043d\u044c","formControlName","endDate","type","text","ngbDatepicker","",3,"click"],["endDate","ngbDatepicker"]],template:function(n,t){if(1&n){const o=e.EpF();e.TgZ(0,"form",0),e.TgZ(1,"span",1),e._uU(2,"\u0417 \u0434\u0430\u0442\u0438"),e.qZA(),e.TgZ(3,"input",2,3),e.NdJ("click",function(){return e.CHM(o),e.MAs(4).toggle()}),e.qZA(),e.TgZ(5,"span",4),e._uU(6,"\u0414\u043e"),e.qZA(),e.TgZ(7,"input",5,6),e.NdJ("click",function(){return e.CHM(o),e.MAs(8).toggle()}),e.qZA(),e.qZA()}2&n&&e.Q6J("formGroup",t.form)},directives:[m._Y,m.JL,m.sg,m.Fj,b.J4,m.JJ,m.u],styles:[""],changeDetection:0}),I=$=(0,y.gn)([(0,g.c)()],I);const _e=["map"];function Te(i,n){if(1&i){const t=e.EpF();e.TgZ(0,"div",10),e.TgZ(1,"app-time-range-select",11),e.NdJ("ngModelChange",function(s){return e.CHM(t),e.oxw().currentTime=s}),e.ALo(2,"async"),e.qZA(),e.TgZ(3,"span"),e._uU(4),e.ALo(5,"date"),e.qZA(),e.qZA()}if(2&i){const t=e.oxw();e.xp6(1),e.Q6J("ngModel",t.currentTime)("availableRange",e.lcZ(2,3,t.movementsTimeRange$)),e.xp6(3),e.Oqu(e.Dn7(5,5,t.currentTime,t.DateTimeFormat,t.UkraineTimeZone))}}function Ie(i,n){if(1&i){const t=e.EpF();e.TgZ(0,"div",10),e.TgZ(1,"app-date-range-selector",11),e.NdJ("ngModelChange",function(s){return e.CHM(t),e.oxw().dateRange=s}),e.ALo(2,"async"),e.qZA(),e.TgZ(3,"div"),e.TgZ(4,"input",2),e.NdJ("ngModelChange",function(s){return e.CHM(t),e.oxw().ignoreEndDate=s}),e.qZA(),e.TgZ(5,"span",3),e.NdJ("click",function(){e.CHM(t);const s=e.oxw();return s.ignoreEndDate=!s.ignoreEndDate}),e._uU(6,"\u043b\u0438\u0448\u0435 \u043f\u043e \u0434\u0430\u0442\u0456 \u043f\u043e\u0447\u0430\u0442\u043a\u0443 \u043f\u043e\u0437\u0438\u0446\u0456\u0457"),e.qZA(),e.qZA(),e.qZA()}if(2&i){const t=e.oxw();e.xp6(1),e.Q6J("ngModel",t.dateRange)("availableRange",e.lcZ(2,3,t.movementsTimeRange$)),e.xp6(3),e.Q6J("ngModel",t.ignoreEndDate)}}let C=class{constructor(n,t){this.store=n,this.mappingItemModalService=t,this._isTimeSlider$=new d.X(!0),this._ignoreEndDate$=new d.X(!1),this.UkraineTimeZone=v.wy,this.DateTimeFormat=v.U5,this.movements$=this.store.pipe((0,c.Ys)(M.q.selectAssetMovementsAll)),this.movementsTimeRange$=this.store.pipe((0,c.Ys)(M.q.selectAssetMovementsTimeRange)),this._currentTime$=new d.X(0),this._dateRange$=new d.X({start:(new Date).getTime(),end:(new Date).getTime()}),this.selectedTimeRangeFilterFnc$=this._isTimeSlider$.pipe((0,A.w)(o=>o?this._currentTime$.pipe((0,u.U)(s=>function Ze(i,n){return{start:i-n,end:i+n}}(s,36e5)),(0,u.U)(s=>H.bind(null,s))):this._ignoreEndDate$.pipe((0,u.U)(s=>s?we:H),(0,A.w)(s=>this._dateRange$.pipe((0,u.U)(a=>s.bind(null,a))))))),this.currentMovements$=(0,f.a)([this.movements$,this.selectedTimeRangeFilterFnc$.pipe(K(50))]).pipe((0,u.U)(([o,s])=>o.filter(s)),N({bufferSize:1,refCount:!0})),this.geoValue$=this.currentMovements$.pipe((0,u.U)(o=>({type:"FeatureCollection",features:o.map(s=>Object.assign(Object.assign({},s.geo),{properties:{id:s.id}}))})),N({bufferSize:1,refCount:!0})),this.arrowHeadsLayer$=new d.X([]),this.arrowHeadsLines$=this.geoValue$.pipe((0,u.U)(o=>(0,D.UW)(o.features))),this.map$=new d.X(null),this.geoJsonLayer$=new d.X(null)}set isTimeSlider(n){this._isTimeSlider$.next(n)}get isTimeSlider(){return this._isTimeSlider$.value}set ignoreEndDate(n){this._ignoreEndDate$.next(n)}get ignoreEndDate(){return this._ignoreEndDate$.value}set currentTime(n){this._currentTime$.next(n)}get currentTime(){return this._currentTime$.value}set dateRange(n){this._dateRange$.next(n)}get dateRange(){return this._dateRange$.value}addItem(){}ngOnInit(){this.map$.pipe((0,A.w)(n=>(0,f.a)([this.geoValue$,this.geoJsonLayer$]).pipe((0,u.U)(([t,o])=>({mapObject:n,geo:t,geoLayer:o})))),(0,g.t)(this)).subscribe(({geo:n,geoLayer:t})=>{null==t||t.clearLayers(),n&&(null==t||t.addData(n))}),this.map$.pipe((0,oe.h)(n=>!!n),(0,A.w)(n=>(0,f.a)([this.arrowHeadsLines$,this.arrowHeadsLayer$]).pipe((0,u.U)(([t,o])=>({lines:t,heads:o,mapObj:n})))),(0,g.t)(this)).subscribe(({lines:n,heads:t,mapObj:o})=>{if(o)if(t.length!==n.length)if(t.length<n.length){const s=Array.from(Array(n.length-t.length)).map((a,l)=>(0,D.Cl)(o));this.arrowHeadsLayer$.next([...t,...s])}else t.slice(n.length).forEach(s=>{s.remove()}),this.arrowHeadsLayer$.next(t.slice(0,n.length));else n.forEach((s,a)=>{t[a].setPaths(s)})})}ngAfterViewInit(){var n;const t=R.map(null===(n=this.mapElement)||void 0===n?void 0:n.nativeElement).setView(O.E,O.T);R.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:18,minZoom:3,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(t);const s=R.geoJSON(void 0,{onEachFeature:(a,l)=>{l.on("click",Z=>{this.showMoment(a.properties.id,Z.latlng)})}});s.setStyle(a=>({color:(null==a?void 0:a.properties.color)||"#ffffff"})),this.geoJsonLayer$.next(s),s.addTo(t),this.map$.next(t)}showMoment(n,t){this.mappingItemModalService.showMappingItemByMovement(n,t).subscribe()}};function H(i,n){return n.start>=i.start&&n.start<=i.end||n.end>=i.start&&n.end<=i.end||n.start<i.start&&n.end>i.end}function we(i,n){return n.start>=i.start&&n.start<=i.end}C.\u0275fac=function(n){return new(n||C)(e.Y36(c.yh),e.Y36(ve))},C.\u0275cmp=e.Xpm({type:C,selectors:[["app-map-view"]],viewQuery:function(n,t){if(1&n&&e.Gf(_e,5),2&n){let o;e.iGM(o=e.CRH())&&(t.mapElement=o.first)}},decls:12,vars:4,consts:[[1,"border","p-2"],[1,"h5","mb-3"],["type","checkbox",1,"me-2",3,"ngModel","ngModelChange"],[3,"click"],["class","flex-grow-0",4,"ngIf","ngIfElse"],["timeRange",""],[1,"map-container","flex-grow-1"],[1,"map-frame"],[1,"map"],["map",""],[1,"flex-grow-0"],[3,"ngModel","availableRange","ngModelChange"]],template:function(n,t){if(1&n&&(e.TgZ(0,"section",0),e.TgZ(1,"div",1),e.TgZ(2,"input",2),e.NdJ("ngModelChange",function(s){return t.isTimeSlider=s}),e.qZA(),e.TgZ(3,"span",3),e.NdJ("click",function(){return t.isTimeSlider=!t.isTimeSlider}),e._uU(4),e.qZA(),e.qZA(),e.YNc(5,Te,6,9,"div",4),e.YNc(6,Ie,7,5,"ng-template",null,5,e.W1O),e.qZA(),e.TgZ(8,"div",6),e.TgZ(9,"div",7),e._UZ(10,"div",8,9),e.qZA(),e.qZA()),2&n){const o=e.MAs(7);e.xp6(2),e.Q6J("ngModel",t.isTimeSlider),e.xp6(2),e.Oqu(t.isTimeSlider?"\u0437\u0430 \u0447\u0430\u0441\u043e\u043c":"\u0437\u0430 \u0434\u0430\u0442\u0430\u043c\u0438"),e.xp6(1),e.Q6J("ngIf",t.isTimeSlider)("ngIfElse",o)}},directives:[m.Wl,m.JJ,m.On,p.O5,T,I],pipes:[p.Ov,p.uU],styles:["[_nghost-%COMP%]{height:100%;display:flex;flex-direction:column}.map[_ngcontent-%COMP%]{width:100%;height:600px}.map-container[_ngcontent-%COMP%]{margin-right:15px}"],changeDetection:0}),C=(0,y.gn)([(0,g.c)()],C);const xe=[{path:"",component:(()=>{class i{constructor(){}ngOnInit(){}}return i.\u0275fac=function(t){return new(t||i)},i.\u0275cmp=e.Xpm({type:i,selectors:[["app-map-view-page"]],decls:1,vars:0,consts:[[1,"flex-grow-1","pb-1"]],template:function(t,o){1&t&&e._UZ(0,"app-map-view",0)},directives:[C],styles:["[_nghost-%COMP%]{display:flex;flex-direction:column;flex:1}"],changeDetection:0}),i})()}];let ye=(()=>{class i{}return i.\u0275fac=function(t){return new(t||i)},i.\u0275mod=e.oAB({type:i}),i.\u0275inj=e.cJS({imports:[[V.Bz.forChild(xe)],V.Bz]}),i})();var X=r(8796),J=r(4741);let U=(()=>{class i{}return i.\u0275fac=function(t){return new(t||i)},i.\u0275mod=e.oAB({type:i}),i.\u0275inj=e.cJS({imports:[[p.ez,X.o,J.Y]]}),i})(),j=(()=>{class i{}return i.\u0275fac=function(t){return new(t||i)},i.\u0275mod=e.oAB({type:i}),i.\u0275inj=e.cJS({imports:[[p.ez,X.o,J.Y,U]]}),i})(),Ae=(()=>{class i{}return i.\u0275fac=function(t){return new(t||i)},i.\u0275mod=e.oAB({type:i}),i.\u0275inj=e.cJS({imports:[[p.ez,U,j,J.Y]]}),i})(),be=(()=>{class i{}return i.\u0275fac=function(t){return new(t||i)},i.\u0275mod=e.oAB({type:i}),i.\u0275inj=e.cJS({imports:[[p.ez,Ae,U,j]]}),i})(),Se=(()=>{class i{}return i.\u0275fac=function(t){return new(t||i)},i.\u0275mod=e.oAB({type:i}),i.\u0275inj=e.cJS({imports:[[p.ez,m.u5,m.UX]]}),i})(),Re=(()=>{class i{}return i.\u0275fac=function(t){return new(t||i)},i.\u0275mod=e.oAB({type:i}),i.\u0275inj=e.cJS({imports:[[p.ez,b.IJ,m.u5,m.UX]]}),i})(),De=(()=>{class i{}return i.\u0275fac=function(t){return new(t||i)},i.\u0275mod=e.oAB({type:i}),i.\u0275inj=e.cJS({imports:[[p.ez,m.u5,m.UX,be,Se,Re]]}),i})(),Fe=(()=>{class i{}return i.\u0275fac=function(t){return new(t||i)},i.\u0275mod=e.oAB({type:i}),i.\u0275inj=e.cJS({imports:[[p.ez,ye,De]]}),i})()}}]);